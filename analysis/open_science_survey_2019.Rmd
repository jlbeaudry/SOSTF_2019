---
title: "Swinburne Open Science Task Force Survey (2019)"
author: "Jennifer L Beaudry, Tom Johnstone, Jordy Kaufman & Lisa Given"
date: '`r format (Sys.time(), "%d %B %Y")`'
output:
 # word_document: default
  html_document: default
csl: apa-old-doi-prefix.csl
bibliography: Beaudry_Library.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```


```{r library, include=FALSE}
#load the library
library(tinytex)
library(knitr)
library(here)
library(tidyverse)
library(skimr)
library(ggbeeswarm)
library(plyr) 
library(plotly)
library(RColorBrewer)
library(kableExtra)
```

```{r function_defs, include=FALSE}
# define functions here

## CALCULATE PERCENTAGES ##

perc <- function (x,y){  #x = variable; #y = n of valid cases from above
  c <- plyr::count (x)         #frequencies per level
  round (100*(c [,2] / y), 0) #rounding to 0 decimal places   
}

## PIE CHART ##

# Tom's to-do list
    # open-ended data to Lisa...
    # Tom to try to round to integer
    # change y-axis & include parameter, which will change the data: done
    # add in ability to order according to different criteria (labels or coded number): added order by response order. Still to add order by number of responses.
 
simple_pie_chart <- function (the_data, label_var="CodeExp", the_title="", colours, order = "ByRespNum"){

# sort the data by response option order
sort_var = paste(label_var,"_num",sep="")
the_data <- the_data[order(the_data[[sort_var]]),]

#tally the responses for each response option
pie_data <- table (the_data[[label_var]])
# calculate number of valid responses for this variable
nvalid <- sum (pie_data)

# here we use formatting to insert an integer number into the title text
the_title = sprintf(the_title,nvalid)

pie_dataframe <- as.data.frame(pie_data)

#rounded_pcts = round(100*pie_dataframe$freq/sum(pie_dataframe$freq))
# Create the pie chart
p <- plot_ly(the_data, labels = the_data[[label_var]], values = the_data[[sort_var]], type = 'pie',
             textposition = "inside",
             textinfo = 'label+percent',
             #text = ~paste(rounded_pcts),
             #textinfo='text',

             marker = list(colors = colours, line=list(color="white", width=10)),
             showlegend = FALSE,
             sort = FALSE,
             direction = "clockwise",
             rotation = 0,
             hole = 0.3,
             pull = 0,
             title = list 
                (text = the_title, position = "top center",font = list (size=20, color="black")))
return(p)
}

## BAR CHART HISTOGRAM ##


simple_bar_graph <- function (the_data, label_var = "", the_title = "", 
                              yname = "Count", xname = "Response",
                              bar_colour = "blue",line_colour = "",line_width = 1){

  
  # sort the data by response option order
  sort_var = paste(label_var,"_num",sep="")
  the_data <- the_data[order(the_data[[sort_var]]),]

  #tally the responses for each response option
  bar_data <- table (the_data[[label_var]])
  # calculate number of valid responses for this variable
  nvalid <- sum (bar_data)
  
  # plot the Count, unless y-axis has been specified as "Percentage"
  ynorm = ""
  if (yname=="Percentage") ynorm = "percentage"
  
  # here we use formatting to insert an integer number into the title text
  the_title = sprintf (the_title,nvalid)
  
  # create labels for the graph elements
  qtext <- "What is your experience with open materials and/or code?"
  
  if (line_colour == "") line_width <- 0
  # create the plot
  p <- plot_ly(
    x = the_data[[label_var]],
    histfunc="count",
    histnorm=ynorm,
    orientation="v",
    type = "histogram",
    marker = list(color = bar_colour,
                           line = list(color = line_colour, width = line_width))) %>%
    layout (title = the_title, 
            yaxis = list (title=yname), 
            xaxis = list (title=xname,type="category",categoryorder="trace"))
  return(p)
}

  # Tom's to-do list
    # open-ended data to Lisa...
    # Tom to try to round to integer
    # change y-axis & include parameter, which will change the data
    # add in ability to order according to different criteria (labels or coded number)

```

```{r import data, include=FALSE}
#import the data. Here I'm using the original Qualtrics data, rather than Jordy's revised one.
df <- read_csv (here::here("data", "data_sostf.csv"))
```

```{r demographics, include=FALSE}

n <- nrow(df$ParticipantNumber)
valid_ac_level <- filter(df, AcLevel_Label != "NA")
nvalid_ac_level <- nrow(valid_ac_level)
per_ac_level <- perc(x = df$AcLevel_Label, y = nvalid_ac_level) 



```

# Overview

We conducted a survey in September 2019 to examine people's current use of open 
science practices, to examine their perceptions of these practices, and to examine
their perceived barriers to using these practices. Across the university, `r n` 
started the survey, although not all respondents completed all questions; thus, 
we report the sample size for each question. This document presents an overview of their responses. 

In terms of their demographics, we did not obtain information about gender or age
to provide more anonymity to our respondents. We did, however, ask about their Academic 
Level/Type and their Discpline (based on 2-digit and 4-digit Field of Research [FOR] codes). Of the `r nrow(valid_ac_level)` respondents who provided details about their Academic Level, `r per_ac_level [5]`% were PhD students, `r per_ac_level [7]`% were Professors, and 
`r per_ac_level [10]`% were Senior Lecturers. The breakdown of the rest of the academic
levels for the rest of the respondents are in the table below. 

```{r ac_level_table, echo=FALSE, warning=TRUE}

a2 <- valid_ac_level %>% 
  dplyr::count(AcLevel_Label) %>% 
   mutate (Percentage = round (n/nvalid_ac_level*100))


dplyr::arrange(a2, desc(n)) %>% 
knitr::kable(col.names = c("Academic Levels", "Frequency", "Percentage"), caption = sprintf("Academic Levels of Respondents (n = %d)",nvalid_ac_level)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

# title = "Academic Level of Respondents (n = %d)"

# Tom, I can't figure out how to arrange this by frequency. It looks super messy 
  # otherwise...
#p <-  simple_bar_graph(df, label_var = "AcLevel_Label", 
#                       the_title = title, 
#                       xname = "What is your academic level/type?", 
#                       bar_colour = "blue",
#                       line_colour = "black") %>% 
#  layout(xaxis = list(categoryorder='trace'))

# will need to figure out how to reorder data....

ap <- ggplot(data = valid_ac_level, aes (AcLevel_Label)) + 
  geom_bar() +
  labs (x = "Frequency", 
        y = "Academic Levels", 
        title = sprintf("Reported Academic Levels (n = %d)",nvalid_ac_level)) +
  coord_flip() + 
  theme_classic(base_size = 12)
ap

ggsave(here::here("figs", "aclevels_bar.png"))

```

<!--NEED TO RECODE THE FOR CODES. FOR NOW, I COULD PULL IN THIS DATA FROM JORDY'S, BUT THAT'S LESS THAN IDEAL. EITHER WAY INSERT THESE DETAILS HERE-->
  
  
  
```{r crisis_by_estimate, include = FALSE}

# filter rows with valid responses 
valid_rep_est <- filter(df, RepEstimate != "NA")

# calculate number of rows with a valid response 
nvalid_rep_est <- nrow(valid_rep_est)

# filter rows with valid responses for CRISIS & rename variable accordingly
nvalid_crisis <- filter(df, crisis != "NA") %>% 
  nrow()


per_crisis <- perc(x = df$crisis, y = nvalid_crisis)  #percentage per level 
# divided by number of valid cases for the crisis variable

# output of `p` inserted in text below
```

## Estimates of Reproducibility by Perceived Crisis  

Participants were asked if they believed their field is experiencing a "reproducibility crisis". Of the `r nvalid_crisis` respondents who answered this question, `r per_crisis[1]`% indicated that they didn't know if there was a crisis, `r per_crisis[2]`% indicated there was no crisis, `r per_crisis[4]`% indicated that there was a slight crisis, and `r per_crisis[3]`% that there was a significant reproducibility crisis in their field.   

Participants were also asked to estimate the percentage of research publications 
their field that are reproducible. In the figure below, we plotted participants' 
reproducibility estimates according to their responses to the perceived 
crisis in their field. The black bar is the mean estimate of reproducibility 
perceived crisis. 
  
  

```{r crisis_by_estimate_stripchart, echo = FALSE, include = TRUE}
#estimates of reproducibility by levels of crisis as a stripchart 

title = sprintf("Estimates of reproducibility by perceived crisis in field (n = %d)",nvalid_rep_est)
x_name = "Do you think your field is experiencing a 'Reprodubility Crisis'?"
x_labels = c("Don't Know", "No Crisis", "Slight Crisis", "Significant Crisis")
y_name = "Estimated %age of reproducible studies"

p <- ggplot(data = valid_rep_est, 
       aes(x=crisis, y=RepEstimate)) + 
  geom_jitter(position=position_jitter(height=0,width=.15),
              fill="blue",
              colour="blue",
              size = 2.2,
              alpha=.5) +
  stat_summary(fun.y=mean,
               fun.ymin=mean,
               fun.ymax=mean,
               geom='crossbar',
               width=0.5) +
  scale_x_discrete(name = x_name, limits = x_labels) +
  scale_y_continuous(name = y_name) +
  coord_cartesian(ylim = c(0,100)) +
  theme_classic (base_size = 12) +
  ggtitle(title)

p

# if we want a separate file of the figure, use this code & it will be saved in 
  # the figs folder. This will be handy if we want to create slides.
# ggsave(here::here("figs", "reprod_estimates_by_crisis.png"))
```
  
   
## Experience with Open Science Practices

  
### Overall Experience with Open Science Practices

```{r os_experience, include = FALSE, warning=TRUE}

# filter rows with valid response for this variable & rename variable accordingly

valid_os_exp <- filter(df, OverallExp != "NA")
valid_os_exp_num <- filter(df, OverallExp_num != "NA")
# these should be the same, but based on variable with numbers & one based on labels 

# calculate number of rows with a valid response for this variable
nvalid_os_exp <- nrow(valid_os_exp)

per_os_exp <- perc(x = valid_os_exp$OverallExp, y = nvalid_os_exp)


#count outputs in case that's what we are going to report instead...
c_os_exp <- count(valid_os_exp$OverallExp)

# just an FYI that this does the same thing as the code above
#nvalid_os_exp <- df %>% 
  #filter (OverallExperience != "NA") %>% 
  #nrow()
```

Before we asked participants about their experience with open science practices, we explained that the practices enveloped by the umbrella term of "open science" were study preregistration, open materials and/or code, open data, pre-publication archiving, and open access publishing.   

The figure below shows participants' experience with open science practices in general. Of the `r nvalid_os_exp` participants who answered this question, `r per_os_exp[4]`% (or, `r c_os_exp[4,2]` if we are going to use frequencies here) reported that they were unaware of open science practices; `r per_os_exp[1]`% reported that they were aware of open science practices, but had not used them; `r per_os_exp[3]`% reported that they had some experience with open science practices; and only `r per_os_exp[2]`% reported that they had extensive experience with open science practices. 

```{r os_experience_bar, echo=FALSE, warning=TRUE, eval = FALSE}

title = sprintf("Experience with open science practices (n = %d)",nvalid_os_exp)
x_name = "What is your experience with open science practices?"
x_labels = c("Unaware", "Aware, But Not Used", "Some Experience", "Extensive Experience")
y_name = "Frequency"

p <- ggplot(data = valid_os_exp, 
       aes(x = OverallExp)) + 
  geom_bar(
  colour = "black" , 
  fill = "blue") +
  scale_x_discrete(name = "What is your experience with open science practices?",
                   limits=c("Unaware", "Aware, But Not Used", "Some Experience", "Extensive Experience")) + 
  theme_classic(base_size = 12) +
  scale_y_continuous(name = "Frequency") +
  coord_cartesian(ylim = c(0,100)) +
  ggtitle(title)
p

# ggsave(here::here("figs", "os_overallexp_bar.png"))



```


```{r os_experience_pie, echo = FALSE}

title = "What is your experience with open science practices? (n = %d)"

# this works, but it doesn't look great because of the "extensive experience" value

#pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df, "OverallExp", 
                      the_title = title, 
                      colours)
p

# pie(c_os_exp$freq, labels=c_os_exp$x)
# I can play with the pie more to make it look different, but lets decide on one 
  # consistent style & then go from there....
  
```

```{r tables_os_experience, echo = FALSE, eval = FALSE}

# keeping this for now, but we likely won't use the table, right?
  # but, this is a good reminder that it's possible to change the order of the rows in the tables (arranged by descending frequency)
dplyr::arrange(c_os_exp, desc(freq)) %>% 
knitr::kable(col.names = c("Overall Experience", "Frequency"), caption = "Overall Experience with Open Science Practices")

```

### Experience with different types of open science practices
   
Next, we break down the results according to their experience with specific types of open science practices. 

#### Experience with Study Preregistration

```{r prereg_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_prereg_exp <- filter(df, PreregExp1 != "NA")

# create object with the counts for each valid response for this variable
c_prereg_exp <- count(valid_prereg_exp$PreregExp1)

# calculate number of rows with a valid response for this variable
nvalid_prereg_exp <- nrow(valid_prereg_exp)

# calculate the percentage for each response
per_prereg_exp <- perc(x = df$PreregExp1, y = nvalid_prereg_exp)

```


Of the `r nvalid_prereg_exp` participants who answered this question, `r per_prereg_exp[4]`% were unaware of study preregistration; `r per_prereg_exp[1]`% were aware of study preregistration, but had not used it; `r per_prereg_exp[3]`% had some experience with it, but did not regularly preregister their studies; and `r per_prereg_exp[2]`% regularly preregistered their studies. 



```{r prereg_table, echo=FALSE, warning=TRUE}

p2 <- valid_prereg_exp %>% 
  dplyr::count(PreregExp1) %>% 
  mutate(Percentage = round (n/nvalid_prereg_exp*100))

dplyr::arrange(p2, desc(n)) %>% 
knitr::kable (col.names = c("Preregistration Experience", "Frequency", "Percentage"), caption = sprintf("Experience with Study Preregistration (n = %d)", nvalid_prereg_exp)) %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

### Experience with Open Materials and/or Code

```{r code_count, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_code <- filter(df,CodeExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_code <- nrow(valid_code)


```


The following section shows how many people have experience with open code and/or materials. A
total of `r nvalid_code` answered this question.

```{r code_table, echo=FALSE, warning=TRUE}

c2 <- valid_code %>% 
  dplyr::count(CodeExp) %>%  
    mutate(Percentage = round (n/nvalid_code*100))

dplyr::arrange(c2, desc(n)) %>% 
knitr::kable (col.names = c("Experience with Open Materials & Code", "Frequency", "Percentage"), caption = sprintf("Experience with Open Materials & Code (n = %d)", nvalid_code)) %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

```{r code_bar, echo = FALSE, warning = TRUE, eval = FALSE}
title = "What is your experience with open materials and/or code (n = %d)"

p <- simple_bar_graph(df, label_var = "CodeExp", the_title = title, xname = "What is your experience with open materials and/or code?", bar_colour = "orange",line_colour = "black")
p
```

```{r code_pie, echo = FALSE, warning = TRUE}
title = "What is your experience with open materials and/or code (n = %d)"
#pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df,label_var="CodeExp",the_title = title, colours)
p
```


```{r skim df, eval=FALSE, include=FALSE}
#These are chunks from the course I took, that I'm keeping now just for reference
#As a quick first pass, we can use the 'skim()' function to get a simple overview of each variable:
#skim(df)

# Now learning about group_by which appears to be a wonderful development!


frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>% #can call "response" anything you want.
  ungroup() #get in this habit because otherwise you might retain the grouping elsewhere.


# Now playing around with it to include more summary statistics, and to print out the different summary stats in a tiblle.

frames %>%
  group_by(test_item) %>%
  summarise(
    mean_resp = mean(response),
    sd_resp = sd(response),
    count = n()
  ) %>%
  ungroup


# Now play with filter to get summary stats from just a subset of the sample (their responses to only the 'small' objects).

average_response <- frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter(sample_size == "small") #this is not changing the average response variable because it still has everything in it.

#Now play with arrange to get summary stats from just a subset of the sample (their responses to only the 'small' objects), and arrange by condition.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition)

# Now play with select to build on filter & arrange, but to only show some of the columns.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response_small <- average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition) %>%
  select (condition, test_item, response)

average_response_small

# Now use mutate to create a new variable, which takes into account how many trials they completed.

average_response_small <- average_response_small %>%
  mutate (generalisation = response/9) %>%
  select (-response) #now remove response because we don't need it any longer

average_response_small

```
