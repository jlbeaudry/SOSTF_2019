---
title: "Swinburne Open Science Task Force Survey (2019)"
author: "Jennifer L Beaudry, Tom Johnstone, Jordy Kaufman & Lisa Given"
date: '`r format (Sys.time(), "%d %B %Y")`'
output:
 # word_document: default
  html_document: default
csl: apa-old-doi-prefix.csl
bibliography: Beaudry_Library.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 999)
```


```{r library, include=FALSE}
#load the library
library(tinytex)
library(knitr)
library(here)
library(plyr)
library(tidyverse)
library(skimr)
library(ggbeeswarm)
library(plotly)
library(RColorBrewer)
library(kableExtra)
```

```{r function_defs, include=FALSE}
# define functions here

## CALCULATE PERCENTAGES ##

perc <- function (x,y){  #x = variable; #y = n of valid cases
  c <- plyr::count (x)         #frequencies per level
  round (100*(c [,2] / y), 0) #rounding to 0 decimal places   
}

## PIE CHART ##

# Tom's to-do list
    # open-ended data to Lisa...
    # Tom to try to round to integer
    # change y-axis & include parameter, which will change the data: done
    # add in ability to order according to different criteria (labels or coded number): added order by response order. Still to add order by number of responses.
 
simple_pie_chart <- function (the_data, label_var="", the_title="", colours, order = "ByRespNum", the_quantity = "", include_NA = "NO"){

  # the column with the response item numbers
  item_var = paste(label_var,"_num",sep="")
  
  # if including NAs, replace with "no response"
  # and set position of "no response" on graph (e.g., "FIRST" or "LAST")
  if (include_NA != "NO") {
    the_data[[label_var]][is.na(the_data[[label_var]])] <- "No response"
    the_data[[item_var]][is.na(the_data[[item_var]])] <- switch(include_NA,
                                                                FIRST = 0,
                                                                LAST = max(the_data[[item_var]])+1)
  }  
 
  # filter out non-responses
  the_data <- the_data[ !is.na(the_data[[label_var]]),]
  
  # calculate number of rows with a valid response 
  nvalid <- nrow(the_data)
  
  # tally the responses for each response option
  pie_data <- plyr::count(the_data,vars=c(label_var,item_var))
  
  # sort the data by response option order (needs other sort orders added)
  if (order == "ByRespNum") pie_data <- pie_data[order(pie_data[[item_var]]),]
  
  # by default display counts
  the_textinfo <- 'label+value'
  the_text = ""
  # display percentages if specified
  if (the_quantity == "percent") {
    pie_data$perc <- paste(as.character(round(100*pie_data$freq/nvalid)),"%",sep="")
    the_textinfo <- 'label+text'
    the_text <- pie_data$perc
  }  
  
  # insert total number of responses into the title text
  the_title = sprintf(the_title,nvalid)
  
  # Create the pie chart
  p <- plot_ly(pie_data, labels = pie_data[[label_var]], values = pie_data$freq, type = 'pie',
               textposition = "inside",
               textinfo = the_textinfo,
               text = the_text,
               marker = list(colors = colours, line=list(color="white", width=10)),
               showlegend = FALSE,
               sort = FALSE,
               direction = "clockwise",
               rotation = 0,
               hole = 0.3,
               pull = 0,
               title = list 
                  (text = the_title, position = "top center",font = list (size=20, color="black")))
  return(p)
}


## BAR CHART HISTOGRAM ##

simple_bar_graph <- function (the_data, label_var = "", the_title = "", 
                              yname = "Count", xname = "Response",
                              bar_colour = "blue",line_colour = "",line_width = 1, include_NA = "NO", order = "ByRespNum", the_quantity = ""){

  # the column with the response item numbers
  item_var = paste(label_var,"_num",sep="")
  
  # if including NAs, replace with "no response"
  # and set position of "no response" on graph
  if (include_NA != "NO") {
    the_data[[label_var]][is.na(the_data[[label_var]])] <- "No response"
    the_data[[item_var]][is.na(the_data[[item_var]])] <- switch(include_NA,
                                                                FIRST = 0,
                                                                LAST = max(the_data[[item_var]])+1)
  }  
  
  # filter out NAs
  the_data <- the_data[ !is.na(the_data[[label_var]]),]
  
  # calculate number of rows with a valid response 
  nvalid <- nrow(the_data)
  
  # tally the responses for each response option
  bar_data <- plyr::count(the_data,vars=c(label_var,item_var))
  
  # sort the data by response option order (needs other sort orders added)
  if (order == "ByRespNum") bar_data <- bar_data[order(bar_data[[item_var]]),]
  
  # by default display counts
  the_column <- "freq"
  yname <- "number of responses"
  # display percentages if specified
  if (the_quantity == "percent") {
    bar_data$perc <- 100*bar_data$freq/nvalid
    the_column <- "perc"
    yname <- "percent of responses"
  }  
  
  # insert total number of responses into the title text
  the_title = sprintf(the_title,nvalid)
  
  # create labels for the graph elements
  qtext <- "What is your experience with open materials and/or code?"
  
  if (line_colour == "") line_width <- 0
  # create the plot
  p <- plot_ly(
    x = bar_data[[label_var]],
    y = bar_data[[the_column]],
    type = "bar",
    orientation="v",
    marker = list(color = bar_colour,
                           line = list(color = line_colour, width = line_width))) %>%
    layout (title = the_title, 
            yaxis = list (title=yname), 
            xaxis = list (title=xname,type="category",categoryorder="trace"))
  return(p)
}

```

```{r import data, include=FALSE}
#import the data. Here I'm using the original Qualtrics data, rather than Jordy's revised one.
df <- read_csv (here::here("data", "data_sostf.csv"))
```

```{r demographics_ac_level, include=FALSE}

n <- length(df$ParticipantNumber)
valid_ac_level <- filter(df, AcLevel_Label != "NA")
nvalid_ac_level <- nrow(valid_ac_level)
per_ac_level <- perc(x = df$AcLevel_Label, y = nvalid_ac_level) 

```

# Overview

We conducted a survey in September 2019 to examine people's current use of open 
science practices, to examine their perceptions of these practices, and to examine
their perceived barriers to adopting these practices. Across the university, `r n` 
started the survey, although not all respondents completed all questions; thus, 
we report the sample size for each question. This document presents an overview of their responses. 

In terms of respondents' demographic information, we did not collect information about gender or age
to provide more anonymity to our respondents. We did, however, ask about their Academic 
Level/Type and their Discpline (based on 2-digit and 4-digit Field of Research [FOR] codes). Of the `r nrow(valid_ac_level)` respondents who provided details about their Academic Level, `r per_ac_level [5]`% were PhD students, `r per_ac_level [7]`% were Professors, and 
`r per_ac_level [10]`% were Senior Lecturers. The breakdown of the rest of the academic
levels for the rest of the respondents are in the table below. 

```{r ac_level_table, echo=FALSE, warning=TRUE}

a2 <- valid_ac_level %>% 
  dplyr::count(AcLevel_Label) %>% 
   mutate (Percentage = round (n/nvalid_ac_level*100))

# arrange by descending frequency

# dplyr::arrange(a2, desc(n)) %>% 
# knitr::kable(col.names = c("Academic Levels", "Frequency", "Percentage"), caption = sprintf("Academic # Levels of Respondents (n = %d)",nvalid_ac_level)) %>% 
#  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

# rearrange the rows

# specify the exact order of the columns based on AcLevels (select them according to the order
  # of the rows in the tibble! YES IT WORKS!)
a3 <-a2 [c(7,1,10,11,2,9,6,5,3,8,4),]

knitr::kable(a3, col.names = c("Academic Levels", "Frequency", "Percentage"), caption = sprintf("Academic Levels of Respondents (n = %d)",nvalid_ac_level)) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')


#ap <- ggplot(data = valid_ac_level, aes (AcLevel_Label)) + 
#  geom_bar() +
#  labs (x = "Frequency", 
#        y = "Academic Levels", 
#        title = sprintf("Reported Academic Levels (n = %d)",nvalid_ac_level)) +
#  coord_flip() + 
#  theme_classic(base_size = 12)
#ap

# code to save figure. If using it for slides, increase the 'base_size' from 12 to 18. 
#ggsave(here::here("figs", "aclevels_bar.png"))

```


```{r demographics_discipline, include=FALSE}

valid_disc <- filter(df, discipline != "Not Specified")
nvalid_disc <- nrow(valid_disc)
valid_per_disc <- perc(x = valid_disc$discipline, y = nvalid_disc) 
FOR_freq <- df %>% 
  select (FORcode_2_num, FORcode_2_label) %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label) %>% 
  arrange(-desc(FORcode_2_num))
```


In terms of Field of Research Codes, we had at least one response from respondents 
who classified themselves as belonging to the two-digit FOR codes from 01 to 20, one 
person indicated "Other", and `r FOR_freq[20,3]` respondents did not specify their 
FOR code. We did not have any responses from researchers in Earth Sciences (04), 
Agricultural and Veterinary Sciences (07), History and Archeology (21),
and Philosophy and Religious Studies (22). 

```{r FOR_table, echo=FALSE, warning=TRUE}

d2 <- df %>% 
  select (c(FORcode_2_num, FORcode_2_label)) %>% 
  dplyr::count(FORcode_2_num,FORcode_2_label) %>% 
  mutate (Percentage = round (n/nrow(df)*100))

# specify the exact order of the columns based on d2 (select them according to the order
  # of the rows in the tibble)
f2 <-d2 [c(12,16,3,8,1,9,7,20,13,2,6,5,4,19,17,11,18,10,15,14),]

dplyr::arrange(f2,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency", "Percentage"), caption = sprintf("Reported Two-Digit Field of Research Codes for Respondents (n = %d)",nrow(df))) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```


```{r FOR_table_by_role, echo=FALSE, warning=TRUE, eval = FALSE}

# Now look at how the data changes according to their academic level (student or not)
#  very few unspecified with students! Out of the 54 students, only 1 'other' and 1 'unspecified'

student <- dplyr::filter(df, AcLevel_Label == "PhD Student" | AcLevel_Label == "Masters Student" | AcLevel_Label == "Research Assistant") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(student,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"), caption = sprintf("Reported Two-Digit Field of Research Codes for Student Respondents (n = %d)",(sum(student$n)))) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

# now showing the staff breakdown

staff <- dplyr::filter(df, AcLevel_Label == "Professor" | AcLevel_Label == "Associate Professor" | AcLevel_Label == "Senior Lecturer" | AcLevel_Label == "Senior Research Fellow" | AcLevel_Label == "Lecturer" | AcLevel_Label == "Research Fellow" | AcLevel_Label == "Postdoc") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(staff,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"), caption = sprintf("Reported Two-Digit Field of Research Codes for Staff Respondents (n = %d)",(sum(staff$n)))) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

# now showing for respondents who did not specify their academic levels (NA or 'other')

unknown <- dplyr::filter(df, is.na(AcLevel_Label) | AcLevel_Label == "Other") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(unknown,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"), caption = sprintf("Reported Two-Digit Field of Research Codes for Unknown Academic Levels (n = %d)",(sum(unknown$n)))) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

For ease of interpretation and to reduce the identifiability of the respondents, 
for the FOR divisions with a small number of respondents (less than 10), we combined 
similar divisions into disciplinary groups. Specifically, the new discipline grouping of Arts, 
Social Sciences, and Humanities (ASSH) included Education (FOR = `r FOR_freq[11,1]`, 
<em>n</em> = `r FOR_freq[11,3]`); Studies in Human Society (FOR = `r FOR_freq[14,1]`, 
<em>n</em> = `r FOR_freq[14,3]`); Studies in Creative Arts and Writing 
(FOR = `r FOR_freq[17,1]`, <em>n</em> = `r FOR_freq[17,3]`); and Language, Communication
and Culture (FOR = `r FOR_freq[18,1]`, <em>n</em> = `r FOR_freq[18,3]`). 
The new discipline grouping of Business & Law included Economics (FOR = 
`r FOR_freq[12,1]`, <em>n</em> = `r FOR_freq[12,3]`); Commerce, Management, Tourism
and Services (FOR = `r FOR_freq[13,1]`, <em>n</em> = `r FOR_freq[13,3]`), and Law
and Legal Studies (FOR = `r FOR_freq[16,1]`, <em>n</em> = `r FOR_freq[16,3]`), 
The new discipline grouping of Technology & Computer Sciences included Information 
and Computing Sciences (FOR = `r FOR_freq[6,1]`, <em>n</em> = `r FOR_freq[6,3]`),
and Technology (FOR = `r FOR_freq[8,1]`, <em>n</em> = `r FOR_freq[8,3]`). We 
allocated Built Environment and Design (FOR = `r FOR_freq[10,1]`, <em>n</em> = 
`r FOR_freq[10,3]`) to the "Other" category. 
  
We retained the FOR divisions of Engineering (FOR = `r FOR_freq[7,1]`, <em>n</em> = 
`r FOR_freq[7,3]`); Medical and Health Sciences (FOR = `r FOR_freq[9,1]`, <em>n</em> = 
`r FOR_freq[9,3]`); Physical Sciences (FOR = `r FOR_freq[2,1]`, <em>n</em> = 
`r FOR_freq[2,3]`); and Psychology and Cognitive Sciences (FOR = `r FOR_freq[15,1]`, 
<em>n</em> = `r FOR_freq[15,3]`) as their own discipline groupings. The breakdown 
for the number of respondents according to discpline groupings is displayed in the next table.
  
<em>I AM SURE YOU WILL ALL AGREE THAT WE DON'T NEED THESE TWO PARAGRAPHS IN THE 
MAIN TEXT, BUT LEAVING IT FOR NOW TO MAKE SURE WE UNDERSTAND HOW EVERYTHING WAS 
GROUPED TOGETHER.</em> :)

```{r discipline_table, echo=FALSE, warning=TRUE}

d2 <- df %>% 
  dplyr::count(discipline) %>% 
   mutate (Percentage = round (n/nrow(df)*100))

# specify the exact order of the columns based on d3 (select them according to the order
  # of the rows in the tibble)
d3 <-d2 [c(4,8,10,3,5,1,2,9,7,6),]

dplyr::arrange(d3) %>% 
knitr::kable(col.names = c("Disciplines", "Frequency", "Percentage"), caption = sprintf("Discipline Groupings of Respondents (n = %d)",nrow(df))) %>% 
  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

# grouping the stem & non-stem disciples together
df <- df %>% 
  mutate (assh = ifelse (discipline %in% c ("Business & Law", "ASSH"), "ASSH", "STEM"))
                  
#d4 <- assh %>% 
#  dplyr::count(assh) %>% 
#   mutate (Percentage = round (n/nrow(df)*100))

#dplyr::arrange(d4) %>% 
#knitr::kable(col.names = c("Disciplines", "Frequency", "Percentage"), caption = #sprintf("Discipline Groupings of Respondents (n = %d)",nrow(df))) %>% 
#  kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```
  
```{r crisis_by_estimate, include = FALSE}

# filter rows with valid responses 
valid_rep_est <- filter(df, RepEstimate != "NA")

# calculate number of rows with a valid response 
nvalid_rep_est <- nrow(valid_rep_est)

# filter rows with valid responses for CRISIS & rename variable accordingly
nvalid_crisis <- filter(df, crisis != "NA") %>% 
  nrow()


per_crisis <- perc(x = df$crisis, y = nvalid_crisis)  #percentage per level 
# divided by number of valid cases for the crisis variable

# output of `per_crisis` inserted in text below
```

## Estimates of Reproducibility by Perceived Crisis  

Participants were asked if they believed their field is experiencing a "reproducibility crisis". Of the `r nvalid_crisis` respondents who answered this question, `r per_crisis[1]`% indicated that they didn't know if there was a crisis, `r per_crisis[2]`% indicated there was no crisis, `r per_crisis[4]`% indicated that there was a slight crisis, and `r per_crisis[3]`% that there was a significant reproducibility crisis in their field.   

Participants were also asked to estimate the percentage of research publications 
their field that are reproducible. In the figure below, we plotted participants' 
reproducibility estimates according to their responses to the perceived 
crisis in their field. The black bar is the mean estimate of reproducibility 
perceived crisis. 
  
  

```{r crisis_by_estimate_stripchart, echo = FALSE, include = TRUE}
#estimates of reproducibility by levels of crisis as a stripchart 

title = sprintf("Estimates of reproducibility by perceived crisis in field (n = %d)",nvalid_rep_est)
x_name = "Do you think your field is experiencing a 'Reprodubility Crisis'?"
x_labels = c("Don't Know", "No Crisis", "Slight Crisis", "Significant Crisis")
y_name = "Estimated % of reproducible studies"

p <- ggplot(data = valid_rep_est, 
       aes(x=crisis, y=RepEstimate)) + 
  geom_jitter(position=position_jitter(height=0,width=.15),
              fill="blue",
              colour="blue",
              size = 2.2,
              alpha=.5) +
  stat_summary(fun.y=mean,
               fun.ymin=mean,
               fun.ymax=mean,
               geom='crossbar',
               width=0.5) +
  scale_x_discrete(name = x_name, limits = x_labels) +
  scale_y_continuous(name = y_name) +
  coord_cartesian(ylim = c(0,100)) +
  theme_classic (base_size = 12) +
  ggtitle(title)

p

# code to save it in the figs folder. Increase 'base_size' from 12 to 18 for slides. 
# ggsave(here::here("figs", "reprod_estimates_by_crisis.png"))
```
  
   
## Experience with Open Science Practices

  
### Overall Experience with Open Science Practices

```{r os_experience, include = FALSE, warning=TRUE}

# filter rows with valid response for this variable & rename variable accordingly

valid_os_exp <- filter(df, OverallExp != "NA")
valid_os_exp_num <- filter(df, OverallExp_num != "NA")
# these should be the same, but based on variable with numbers & one based on labels 

# calculate number of rows with a valid response for this variable
nvalid_os_exp <- nrow(valid_os_exp)

per_os_exp <- perc(x = valid_os_exp$OverallExp, y = nvalid_os_exp)


#count outputs in case that's what we are going to report instead...
c_os_exp <- plyr::count(valid_os_exp$OverallExp)

# just an FYI that this does the same thing as the code above
#nvalid_os_exp <- df %>% 
  #filter (OverallExperience != "NA") %>% 
  #nrow()
```

Before we asked participants about their experience with open science practices, we explained that the practices enveloped by the umbrella term of "open science" were study preregistration, open materials and/or code, open data, pre-publication archiving, and open access publishing.   

The figure below shows participants' experience with open science practices in general. Of the `r nvalid_os_exp` participants who answered this question, `r per_os_exp[4]`% (or, `r c_os_exp[4,2]` if we are going to use frequencies here) reported that they were unaware of open science practices; `r per_os_exp[1]`% reported that they were aware of open science practices, but had not used them; `r per_os_exp[3]`% reported that they had some experience with open science practices; and only `r per_os_exp[2]`% reported that they had extensive experience with open science practices. 

```{r os_experience_bar, echo=FALSE, warning=TRUE, eval = FALSE}

title = sprintf("Experience with open science practices (n = %d)",nvalid_os_exp)
x_name = "What is your experience with open science practices?"
x_labels = c("Unaware", "Aware, But Not Used", "Some Experience", "Extensive Experience")
y_name = "Frequency"

p <- ggplot(data = valid_os_exp, 
       aes(x = OverallExp)) + 
  geom_bar(
  colour = "black" , 
  fill = "blue") +
  scale_x_discrete(name = "What is your experience with open science practices?",
                   limits=c("Unaware", "Aware, But Not Used", "Some", "Extensive")) + 
  theme_classic(base_size = 12) +
  scale_y_continuous(name = "Frequency") +
  coord_cartesian(ylim = c(0,100)) +
  ggtitle(title)
p

# ggsave(here::here("figs", "os_overallexp_bar.png"))



```


```{r os_experience_pie, echo = FALSE}

title = "What is your experience with open science practices? (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = df, label_var = "OverallExp",
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r os_experience_pie_assh, echo = FALSE, eval = FALSE}

# data for just ASSH respondents
title = "What is your experience with open science practices? HAS respondents (n = %d)"
d_assh <- df %>% filter(assh == "ASSH")

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = d_assh, label_var = "OverallExp",
                      the_title = title, 
                      colours,the_quantity = "percent")
p

# data for just STEM respondents
title = "What is your experience with open science practices? STEM respondents (n = %d)"
d_stem <- df %>% filter(assh == "STEM")

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = d_stem, label_var = "OverallExp",
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r tables_os_experience, echo = FALSE, eval = TRUE}

# keeping this for now because it's useful to double check values.

os2 <- valid_os_exp %>% 
    dplyr::count(OverallExp) %>% 
  mutate(Percentage = round (n/nvalid_os_exp*100))

dplyr::arrange(os2, desc(n)) %>% 
knitr::kable(col.names = c("Overall Experience", "Frequency", "Percentage"), caption = sprintf("Overall Experience with Open Science Practices (n = %d)", nvalid_os_exp))  %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

### Experience with different types of open science practices
   
Next, we break down the results according to their experience with specific types of open science practices. 

#### Experience with Study Preregistration

```{r prereg_exp_count, echo = FALSE, warning=TRUE}
# filter rows with valid responses for this variable
valid_prereg_exp <- filter(df, PreregExp1 != "NA")

# create object with the counts for each valid response for this variable
c_prereg_exp <- plyr::count(valid_prereg_exp$PreregExp1)

# calculate number of rows with a valid response for this variable
nvalid_prereg_exp <- nrow(valid_prereg_exp)

# calculate the percentage for each response
per_prereg_exp <- perc(x = valid_prereg_exp$PreregExp1, y = nvalid_prereg_exp)

```

Of the `r nvalid_prereg_exp` participants who answered this question, `r per_prereg_exp[4]`% were unaware of study preregistration; `r per_prereg_exp[1]`% were aware of study preregistration, but had not used it; `r per_prereg_exp[3]`% had some experience with it, but did not regularly preregister their studies; and `r per_prereg_exp[2]`% regularly preregistered their studies. 

```{r prereg_exp_pie_chart, echo = FALSE, warning = TRUE}

title = "What is your experience with preregistration? (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = df, label_var = "PreregExp1", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
rm(title)
```


```{r prereg_exp_pie_chart_assh, echo = FALSE, warning = TRUE, eval=FALSE}

d_assh <- df %>% filter(assh == "ASSH") 
title = "What is your experience with preregistration? HAS respondents (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = d_assh, label_var = "PreregExp1", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p

rm(title)
```

```{r prereg_exp_table, echo=FALSE, warning=TRUE}

p2 <- valid_prereg_exp %>% 
  dplyr::count(PreregExp1) %>% 
  mutate(Percentage = round (n/nvalid_prereg_exp*100))

p2$PreregExp1 <- p2$PreregExp1 %>% 
  mapvalues(
    c("Unaware", "Aware, But Not Used", "Some Experience", "Reg Use"), 
    c("Unaware", "Aware, But Not Used", "Some Experience", "Regular Use"))

dplyr::arrange(p2, desc(n)) %>% 
knitr::kable (col.names = c("Preregistration Experience", "Frequency", "Percentage"), caption = sprintf("Experience with Study Preregistration (n = %d)", nvalid_prereg_exp)) %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

#### Perceived Importance about Preregistration 


```{r prereg_imp_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable; first df contains all valid responses
  # the second df contains all valid responses, except "Researchers...do not conduct research
  # studies"
valid_prereg_imp <- filter(df, PreRegImp != "NA")
valid_prereg_imp_ex <- filter(valid_prereg_imp, PreRegImp != "Researchers in my discipline do not conduct research studies")

# create objects with the counts for each valid response for the variable
c_prereg_imp <- plyr::count(valid_prereg_imp$PreRegImp)
c_prereg_imp_ex <- plyr::count(valid_prereg_imp_ex$PreRegImp)

# calculate number of rows with a valid response for this variable
nvalid_prereg_imp <- nrow(valid_prereg_imp)
nvalid_prereg_imp_ex <- nrow(valid_prereg_imp_ex)

# calculate the percentage for each response
per_prereg_imp <- perc(x = valid_prereg_imp$PreRegImp, y = nvalid_prereg_imp)
per_prereg_imp_ex <- perc(x = valid_prereg_imp_ex$PreRegImp, y = nvalid_prereg_imp_ex)

```


Of the `r nvalid_prereg_imp` participants who answered this question, a small percentage 
(`r per_prereg_imp[3]`%) indicated that researchers in their discipline do not conduct 
research studies. As such, we excluded them from this analysis. Of the remaining 
`r nvalid_prereg_imp_ex` respondents, `r per_prereg_imp_ex[1]`% indicated that 
preregistration was extremely important for their field; `r per_prereg_imp_ex[3]`% 
indicated that it was somewhat important; `r per_prereg_imp_ex[4]`% indicated that 
preregistration was somewhat unimportant; and `r per_prereg_imp_ex[2]`% indicated 
that it was not at all important for their field. 

```{r prereg_imp_ex_pie_chart, echo = FALSE, warning = TRUE}

title = "In your opinion, how important for your field is it that researchers preregister their studies (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = valid_prereg_imp_ex, label_var = "PreRegImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r prereg_imp_ex_pie_chart_assh, echo = FALSE, warning = TRUE, eval = FALSE}

title = "How important is it that researchers preregister their studies? HAS respondents (n = %d)"

d_assh <- df %>% 
  filter(assh == "ASSH") %>% 
  filter(PreRegImp != "Researchers in my discipline do not conduct research studies")

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = d_assh, label_var = "PreRegImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```


```{r prereg_imp_ex_table, echo=FALSE, warning=TRUE}

p2 <- valid_prereg_imp_ex %>% 
  dplyr::count(PreRegImp) %>% 
  mutate(Percentage = round (n/nvalid_prereg_imp_ex*100))

p3 <-p2 [c(2,4,3,1),]

p3 %>% 
knitr::kable (col.names = c("Perceived Importance of Preregistration", "Frequency", "Percentage"), caption = sprintf("Perceived Importance of Preregistration (n = %d)", nvalid_prereg_imp_ex)) %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```


```{r prereg_concerns_data, echo=FALSE, warning=TRUE}
# wrangle this data so it's in long form & only includes endorsements.

PreRegCon_long <- df %>% 
     select(c("ParticipantNumber", "PreRegCon_delay", "PreRegCon_look", "PreRegCon_prevent_exp", "PreRegCon_stifle_creativity", "PreRegCon_scooping", "PreRegCon_prevent_sig", "PreRegCon_diff_pub", "PreRegCon_no_con")) %>%  
     pivot_longer(c("PreRegCon_delay", "PreRegCon_look", "PreRegCon_prevent_exp", "PreRegCon_stifle_creativity", "PreRegCon_scooping", "PreRegCon_prevent_sig", "PreRegCon_diff_pub", "PreRegCon_no_con"), 
     names_to = "PreRegConcern", values_to = "PreReg_Endorsement") %>% 
  filter(PreReg_Endorsement == "1")  

# recode the data so the response options have proper labels
  # create a character vector with proper labels
prereg_con_key <- c (PreRegCon_delay = "Delays data collection", 
                     PreRegCon_look = "Need to look at data to analyse it",
                     PreRegCon_prevent_exp = "Prevents exploratory research",
                     PreRegCon_stifle_creativity = "Stifles creativity", 
                     PreRegCon_scooping = "Risk of scooping", 
                     PreRegCon_prevent_sig = "More difficult to find significant results",
                     PreRegCon_diff_pub = "More difficult to publish in certain journals", 
                     PreRegCon_no_con = "No concerns")

  # recode the values with this character vector
PreRegCon_long$PreRegConcern <- recode(PreRegCon_long$PreRegConcern, !!!prereg_con_key)

# getting a tibble for the counts
c_prereg_con <- plyr::count(PreRegCon_long$PreRegConcern)

# to figure out how many respondents shared concerns calculate unique number of participants
n_prereg_con <- length(unique(PreRegCon_long$ParticipantNumber))

# calculate the percentage for each response (of the percentage who answered the question)
per_prereg_con <- perc(x = PreRegCon_long$PreRegConcern, y = n_prereg_con)

# df <- c(c_prereg_con, per_prereg_con)

```

We also asked respondents if they have any concerns about preregistering their studies. 
After asking respondents to share their concerns in a free text format, we then provided a 
list of possible concerns that researchers could have about preregistering their studies. 
Respondents were able to select as many concerns as they liked. Of the `r n_prereg_con`
respondents who answered this question, `r c_prereg_con[5,2]` (`r per_prereg_con [5]`) 
reported that they do not share any of the listed concerns. 

```{r prereg_concerns_bar, echo=FALSE, warning=TRUE}
# build the bar chart
title = sprintf("Concerns about preregistering studies (n = %d)", n_prereg_con)

# creating a tibble with the percentage
df <- PreRegCon_long$PreRegConcern 
df2 <- df %>% 
  count()
  

p <- ggplot(PreRegCon_long, aes (x = PreRegConcern)) +
         geom_bar(fill = "lightskyblue3", colour = "black")  +
    labs (x = element_blank(),
      y = "Frequency", 
        title = title) +
  coord_flip() +
  theme_classic(base_size = 12) 
p

```

<em> %age of those who responded to this question & also make "no concerns" a different colour</em> 

### Experience with Open Materials and/or Code

```{r code_count, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_code <- filter(df,CodeExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_code <- nrow(valid_code)


```


The following section shows how many people have experience with open code and/or materials. A
total of `r nvalid_code` answered this question.

```{r code_pie, echo = FALSE, warning = TRUE}
title = "What is your experience with open materials and/or code (n = %d)"
#pie chart

colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df,label_var="CodeExp",the_title = title, colours = colours, the_quantity="percent")
p
```

```{r code_table, echo=FALSE, warning=TRUE}

c2 <- valid_code %>% 
  dplyr::count(CodeExp) %>%  
    mutate(Percentage = round (n/nvalid_code*100))

dplyr::arrange(c2, desc(n)) %>% 
knitr::kable (col.names = c("Experience with Open Materials & Code", "Frequency", "Percentage"), caption = sprintf("Experience with Open Materials & Code (n = %d)", nvalid_code)) %>% 
    kable_styling(bootstrap_options = "striped", full_width = F, position = 'center')

```

```{r code_bar, echo = FALSE, warning = TRUE, eval = FALSE}
title = "What is your experience with open materials and/or code (n = %d)"
p <- simple_bar_graph(df, label_var = "CodeExp", the_title = title, xname = "Response given", bar_colour = "orange",line_colour = "black",the_quantity="count")
p
```

<emp> %age of those who responded to this question & also make "no concerns" a different colour</emp> 

```{r code_concerns_data, echo=FALSE, warning=TRUE}
# wrangle this data so it's in long form & only includes endorsements.
CodeCon_long <- df %>% 
  select (c("ParticipantNumber", "CodeCon_criticise", "CodeCon_diff_understand", "CodeCon_assistance", "CodeCon_lose_control", "CodeCon_errors", "CodeCon_credit", "CodeCon_no_con", "CodeCon_violate", "CodeCon_ip", "FORcode_2_label")) %>%  
  pivot_longer(c("CodeCon_criticise", "CodeCon_diff_understand", "CodeCon_assistance", "CodeCon_lose_control", "CodeCon_errors", "CodeCon_credit", "CodeCon_no_con", "CodeCon_violate", "CodeCon_ip"), names_to = "CodeConcern", values_to = "CodeCon_Endorsement") %>% 
  filter(CodeCon_Endorsement == "1")

# recode the data so the response options have proper labels
  # create a character vector with proper labels
code_con_key <- c (CodeCon_criticise = "Others might criticise my materials/code", 
                     CodeCon_diff_understand = "Others might find it difficult to understand my materials/code",
                     CodeCon_assistance = "Others might ask for my assistance with their research",
                     CodeCon_lose_control = "I might lose control over how they are used", 
                     CodeCon_errors = "Others might find errors in my published work", 
                     CodeCon_credit = "I might not receive appropriate credit",
                     CodeCon_violate = "Reuse could violate epistemological framework", 
                     CodeCon_ip = "Issues related to intellectual property", 
                     CodeCon_no_con = "No concerns")
  # recode the values with this character vector
CodeCon_long$CodeConcern <- recode(CodeCon_long$CodeConcern, !!!code_con_key)

# getting a tibble for the counts
code_con <- plyr::count(CodeCon_long$CodeConcern)

# need this data to figure out how many respondents shared concerns
  # figure out unique number of participants

n_code_con <- length(unique(CodeCon_long$ParticipantNumber))
  # count the number of unique values (can do that in the title itself in next chunk)
# length(n_con)


c2 <- CodeCon_long %>% 
  filter(CodeCon_long$CodeConcern == "Reuse could violate epistemological framework")

```

We also asked respondents if they have any concerns about making their research materials
and/or code open. After asking respondents to share their concerns in a free text format, 
we provided a list of possible concerns that researchers could have about sharing their materials
and/or code. Respondents were able to select as many concerns as they liked. A total of `r length(n_con)` respondents answered this question. Of those who respondended to this question, 
`r con[4,2]` reported that they do not share any of the listed concerns. 

```{r code_concerns_bar, echo=FALSE, warning=TRUE}
# build the bar chart

title = sprintf("Open materials and/or code\n concerns (n = %d)", length(n_code_con))

p <- ggplot(CodeCon_long, aes (x = CodeConcern)) +
         geom_bar(fill = "lightskyblue3", colour = "black")  +
    labs (x = element_blank(),
      y = "Frequency", 
        title = title) +
  coord_flip() +
  theme_classic(base_size = 12) 
p

```

```{r skim df, eval=FALSE, include=FALSE}
#These are chunks from the course I took, that I'm keeping now just for reference

#As a quick first pass, we can use the 'skim()' function to get a simple overview of each variable:
#skim(df)

# Now learning about group_by which appears to be a wonderful development!


frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>% #can call "response" anything you want.
  ungroup() #get in this habit because otherwise you might retain the grouping elsewhere.


# Now playing around with it to include more summary statistics, and to print out the different summary stats in a tiblle.

frames %>%
  group_by(test_item) %>%
  summarise(
    mean_resp = mean(response),
    sd_resp = sd(response),
    count = n()
  ) %>%
  ungroup


# Now play with filter to get summary stats from just a subset of the sample (their responses to only the 'small' objects).

average_response <- frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter(sample_size == "small") #this is not changing the average response variable because it still has everything in it.

#Now play with arrange to get summary stats from just a subset of the sample (their responses to only the 'small' objects), and arrange by condition.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition)

# Now play with select to build on filter & arrange, but to only show some of the columns.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response_small <- average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition) %>%
  select (condition, test_item, response)

average_response_small

# Now use mutate to create a new variable, which takes into account how many trials they completed.

average_response_small <- average_response_small %>%
  mutate (generalisation = response/9) %>%
  select (-response) #now remove response because we don't need it any longer

average_response_small

```

```{r clean environment, echo = FALSE}
rm(a2)
rm(a3)
rm(c_os_exp)
rm(d_assh)
rm(d_stem)
rm(d2)
rm(d3)
rm(df)
rm(f2)
rm(FOR_freq)
rm(n)
rm(nvalid_ac_level)
rm(nvalid_crisis)
rm(nvalid_disc)
rm(nvalid_os_exp)
rm(nvalid_rep_est)
```

