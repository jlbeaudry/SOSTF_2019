---
title: "Swinburne Open Science Task Force Survey (2019)"
author: "Jennifer L Beaudry, Tom Johnstone, Jordy Kaufman & Lisa Given"
date: '`r format (Sys.time(), "%d %B %Y")`'
output:  
  rmdformats::readthedown:
    self_contained: true
    thumbnails: false
    lightbox: false
    gallery: false
    fig_retina: 1
    toc_depth: 3
  #word_document: 
   # fig_width: 10 # this works, but it changes the font of plot_ly, etc.
   # fig_height: 12 # so, don't use for now
  # html_document:  
    # number_sections: true
    # toc: true
  #pdf_document: default # this works now [but margin issues around plot_ly]
always_allow_html: true # true for word; false for pdf (?)
csl: apa-old-doi-prefix.csl
bibliography: Beaudry_Library.bib
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align= "center")
options(scipen = 999)
options(kableExtra.auto_format = TRUE) 
# If I knit as a word doc:
  # switch auto_format to 'false'; 'true' for pdf or html
  # add 'fig.width = 8, fig.height = 8' to opts_chunk 

# If knit as a pdf or html:
# switch auto_format to 'true' 
# include width and height parameters in the plot_ly function
  #  width = 300, 
  #  height = NULL,
  # along with all other parameters
# need to also figure out how to modify the margins (maybe the orca package or 
  # maybe the webshot settings? More research needed.)
```


```{r library, include=FALSE}
# load the library
# need to install & load `rmdformats` package before you knit
library(tinytex)
library(knitr)
library(here)
library(plyr)
library(tidyverse)
#library(skimr)
library(ggbeeswarm)
#library(ggrepel) use this if I'm going to add labels
library(plotly)
library(RColorBrewer)
library(kableExtra)
library(datapasta) # I don't need this to run the file, so delete when I'm done.
```

```{r function_defs, include=FALSE}
# define functions here

## CALCULATE PERCENTAGES ##

perc <- function (x,y){  #x = variable; #y = n of valid cases
  c <- plyr::count (x)         #frequencies per level
  round (100*(c [,2] / y), 0) #rounding to 0 decimal places   
}

## PIE CHART ##

# Tom's to-do list
    # open-ended data to Lisa...
    # Tom to try to round to integer
    # change y-axis & include parameter, which will change the data: done
    # add in ability to order according to different criteria (labels or coded number): added order by response order. Still to add order by number of responses.
 
simple_pie_chart <- function (the_data, label_var="", the_title="", colours, order = "ByRespNum", the_quantity = "", include_NA = "NO"){

  # the column with the response item numbers
  item_var = paste(label_var,"_num",sep="")
  
  # if including NAs, replace with "no response"
  # and set position of "no response" on graph (e.g., "FIRST" or "LAST")
  if (include_NA != "NO") {
    the_data[[label_var]][is.na(the_data[[label_var]])] <- "No response"
    the_data[[item_var]][is.na(the_data[[item_var]])] <- switch(include_NA,
                                                                FIRST = 0,
                                                                LAST = max(the_data[[item_var]])+1)
  }  
 
  # filter out non-responses
  the_data <- the_data[ !is.na(the_data[[label_var]]),]
  
  # calculate number of rows with a valid response 
  nvalid <- nrow(the_data)
  
  # tally the responses for each response option
  pie_data <- plyr::count(the_data,vars=c(label_var,item_var))
  
  # sort the data by response option order (needs other sort orders added)
  if (order == "ByRespNum") pie_data <- pie_data[order(pie_data[[item_var]]),]
  
  # by default display counts
  the_textinfo <- 'label+value'
  the_text = ""
  # display percentages if specified
  if (the_quantity == "percent") {
    pie_data$perc <- paste(as.character(round(100*pie_data$freq/nvalid)),"%",sep="")
    the_textinfo <- 'label+text'
    the_text <- pie_data$perc
  }  
  
  # insert total number of responses into the title text
  the_title = sprintf(the_title,nvalid)
  
  # Create the pie chart
  p <- plot_ly(pie_data, labels = pie_data[[label_var]], values = pie_data$freq, type = 'pie',
               textposition = "inside",
               textinfo = the_textinfo,
               text = the_text,
               marker = list(colors = colours, line=list(color="white", width=6)),
               showlegend = FALSE,
               sort = FALSE,
               direction = "clockwise",
               rotation = 0,
               hole = 0.25,
               pull = 0,
               title = list 
                  (text = the_title, position = "top center",font = list (size=20, color="black")))
  return(p)
}


## BAR CHART HISTOGRAM ##

simple_bar_graph <- function (the_data, label_var = "", the_title = "", 
                              yname = "Count", xname = "Response",
                              bar_colour = "blue",line_colour = "",line_width = 1, include_NA = "NO", order = "ByRespNum", the_quantity = ""){

  # the column with the response item numbers
  item_var = paste(label_var,"_num",sep="")
  
  # if including NAs, replace with "no response"
  # and set position of "no response" on graph
  if (include_NA != "NO") {
    the_data[[label_var]][is.na(the_data[[label_var]])] <- "No response"
    the_data[[item_var]][is.na(the_data[[item_var]])] <- switch(include_NA,
                                                                FIRST = 0,
                                                                LAST = max(the_data[[item_var]])+1)
  }  
  
  # filter out NAs
  the_data <- the_data[ !is.na(the_data[[label_var]]),]
  
  # calculate number of rows with a valid response 
  nvalid <- nrow(the_data)
  
  # tally the responses for each response option
  bar_data <- plyr::count(the_data,vars=c(label_var,item_var))
  
  # sort the data by response option order (needs other sort orders added)
  if (order == "ByRespNum") bar_data <- bar_data[order(bar_data[[item_var]]),]
  
  # by default display counts
  the_column <- "freq"
  yname <- "number of responses"
  # display percentages if specified
  if (the_quantity == "percent") {
    bar_data$perc <- 100*bar_data$freq/nvalid
    the_column <- "perc"
    yname <- "percent of responses"
  }  
  
  # insert total number of responses into the title text
  the_title = sprintf(the_title,nvalid)
  
  # create labels for the graph elements
  qtext <- "What is your experience with open materials and/or code?"
  
  if (line_colour == "") line_width <- 0
  # create the plot
  p <- plot_ly(
    x = bar_data[[label_var]],
    y = bar_data[[the_column]],
    type = "bar",
    orientation="v",
    marker = list(color = bar_colour,
                           line = list(color = line_colour, width = line_width))) %>%
    layout (title = the_title, 
            yaxis = list (title=yname), 
            xaxis = list (title=xname,type="category",categoryorder="trace"))
  return(p)
}

 ### metadata RENAME ####

meta_rename <-  function(df, metadata, old, new) {
  
  keys   <- metadata[[deparse(substitute(old))]]
  values <- metadata[[deparse(substitute(new))]]
  rename_at(df, vars(keys), ~ values)
}

```

```{r import data, include=FALSE}
#import the data. Here I'm using the original Qualtrics data, rather than Jordy's revised one.
df <- read_csv (here::here("data", "data_sostf.csv"))

# import the metadata.
metadata <- here::here("survey", "data", "os_metadata_good.csv") %>% 
  read_csv(col_names = TRUE, skip_empty_rows = TRUE) %>% 
  filter(!is.na(OldVariable)) %>% 
  select(-c(MinValue:ImportID)) #does not import the extraneous variables
```

```{r demographics_ac_level, include=FALSE}

n <- length(df$ParticipantNumber)
valid_ac_level <- filter(df, AcLevel_Label != "NA")
nvalid_ac_level <- nrow(valid_ac_level)
per_ac_level <- perc(x = df$AcLevel_Label, y = nvalid_ac_level) 

```

Overview

We conducted a survey in September 2019 to examine people's current use of open 
science practices, to examine their perceptions of these practices, and to examine
their perceived barriers to adopting these practices. Across the university, `r n` 
started the survey, although not all respondents completed all questions; thus, 
we report the sample size for each question. This document presents an overview 
of their responses. 

# Demographics


In terms of respondents' demographic information, we did not collect information 
about gender or age to provide more anonymity to our respondents. We did, however,
ask about their Academic Level/Type and their Discpline (based on 2-digit and 
4-digit Field of Research [FOR] codes). 

## Academic Levels 

Of the `r nrow(valid_ac_level)`respondents who provided details about their 
Academic Level, `r per_ac_level [5]`% were PhD students, `r per_ac_level [7]`% 
were Professors, and `r per_ac_level [10]`% were Senior Lecturers. 
The breakdown of the rest of the academic levels for the rest of the respondents 
are in the table below. 

```{r ac_level_table, echo=FALSE, warning=TRUE}

a2 <- valid_ac_level %>% 
  dplyr::count(AcLevel_Label) %>% 
   mutate (Percentage = round (n/nvalid_ac_level*100))

# specify the exact order of the columns based on AcLevels (select them according to the order
  # of the rows in the tibble)
a3 <-a2 [c(7,1,10,11,2,9,6,5,3,8,4),]

knitr::kable(a3, col.names = c("Academic Levels", "Frequency", "Percentage"), 
             caption = sprintf("Academic Levels of Respondents (n = %d)", 
                               nvalid_ac_level), align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```


```{r demographics_discipline, include=FALSE}

valid_disc <- filter(df, discipline != "Not Specified")
nvalid_disc <- nrow(valid_disc)
valid_per_disc <- perc(x = valid_disc$discipline, y = nvalid_disc) 
FOR_freq <- df %>% 
  select (FORcode_2_num, FORcode_2_label) %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label) %>% 
  arrange(-desc(FORcode_2_num))

a <- colSums(FOR_freq[1:18,3])
```

## Disciplines

In terms of Field of Research Codes, `r a` respondents classified themselves 
as belonging to one of the two-digit FOR codes from 01 to 20, one person indicated 
"Other", and `r FOR_freq[20,3]` respondents did not specify their FOR code. We 
did not have any responses from researchers in Earth Sciences (04), Agricultural 
and Veterinary Sciences (07), History and Archeology (21), and Philosophy and 
Religious Studies (22). 

%%% I RECKON I'LL MOVE THIS TO AN APPENDIX %%%

```{r FOR_table, echo=FALSE, warning=TRUE}

d2 <- df %>% 
  select (c(FORcode_2_num, FORcode_2_label)) %>% 
  dplyr::count(FORcode_2_num,FORcode_2_label) %>% 
  mutate (Percentage = round (n/nrow(df)*100))

# specify the exact order of the columns based on d2 (select them according to 
  # the order of the rows in the tibble)
# f2 <-d2 [c(12,16,3,8,1,9,7,20,13,2,6,5,4,19,17,11,18,10,15,14),]
  # I don't seem to be using this in this version, replaced with desc

dplyr::arrange(d2,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency",
                           "Percentage"), 
             caption = sprintf("Reported Two-Digit Field of Research Codes for Respondents (n = %d)", nrow(df)), align = 'clcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```


```{r FOR_table_by_role, echo=FALSE, warning=TRUE, eval = FALSE}

# Now look at how the data changes according to their academic level (student or not)
#  very few unspecified with students! Out of the 54 students, only 1 'other' and 1 'unspecified'
  # I don't need to use this either...CAN CUT THIS WHOLE CHUNK EVENTUALLY

student <- dplyr::filter(df, AcLevel_Label == "PhD Student" | 
                           AcLevel_Label == "Masters Student" | 
                           AcLevel_Label == "Research Assistant") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(student,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"),
             caption = sprintf("Reported Two-Digit Field of Research Codes for Student Respondents (n = %d)", (sum(student[3]))), align = 'clc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

# now showing the staff breakdown

staff <- dplyr::filter(df, AcLevel_Label == "Professor" |
                         AcLevel_Label == "Associate Professor" | 
                         AcLevel_Label == "Senior Lecturer" | 
                         AcLevel_Label == "Senior Research Fellow" | 
                         AcLevel_Label == "Lecturer" | 
                         AcLevel_Label == "Research Fellow" | 
                         AcLevel_Label == "Postdoc") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(staff,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"),
             caption = sprintf("Reported Two-Digit Field of Research Codes for Staff Respondents (n = %d)", (sum(staff[3]))), align = 'clc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

# now showing for respondents who did not specify their academic levels (NA or 'other')

unknown <- dplyr::filter(df, is.na(AcLevel_Label) | 
                           AcLevel_Label == "Other") %>% 
  dplyr::count(FORcode_2_num, FORcode_2_label)

dplyr::arrange(unknown,-desc(FORcode_2_num)) %>% 
knitr::kable(col.names = c("FOR Code", "Field of Research Division", "Frequency"), caption = sprintf("Reported Two-Digit Field of Research Codes for Unknown Academic Levels (n = %d)",(sum(unknown[3])))) %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

For ease of interpretation and to reduce the identifiability of the respondents, 
for the FOR divisions with a small number of respondents (less than 10), we
combined similar divisions into disciplinary groups. Specifically, the new 
discipline grouping of Arts, Social Sciences, and Humanities (ASSH) included 
Education (FOR = `r FOR_freq[11,1]`, <em>n</em> = `r FOR_freq[11,3]`); Studies 
in Human Society (FOR = `r FOR_freq[14,1]`, <em>n</em> = `r FOR_freq[14,3]`); 
Studies in Creative Arts and Writing (FOR = `r FOR_freq[17,1]`, <em>n</em> =
`r FOR_freq[17,3]`); and Language, Communication and Culture (FOR = 
`r FOR_freq[18,1]`, <em>n</em> = `r FOR_freq[18,3]`). The new discipline grouping
of Business & Law included Economics (FOR = `r FOR_freq[12,1]`, <em>n</em> = 
`r FOR_freq[12,3]`); Commerce, Management, Tourism and Services (FOR = 
`r FOR_freq[13,1]`, <em>n</em> = `r FOR_freq[13,3]`), and Law and Legal Studies
(FOR = `r FOR_freq[16,1]`, <em>n</em> = `r FOR_freq[16,3]`). 
The new discipline grouping of Technology & Computer Sciences included Information
and Computing Sciences (FOR = `r FOR_freq[6,1]`, <em>n</em> = `r FOR_freq[6,3]`),
and Technology (FOR = `r FOR_freq[8,1]`, <em>n</em> = `r FOR_freq[8,3]`). We 
allocated Built Environment and Design (FOR = `r FOR_freq[10,1]`, <em>n</em> = 
`r FOR_freq[10,3]`) to the "Other" category. 
  
We retained the FOR divisions of Engineering (FOR = `r FOR_freq[7,1]`, <em>n</em> 
= `r FOR_freq[7,3]`); Medical and Health Sciences (FOR = `r FOR_freq[9,1]`,
<em>n</em> = `r FOR_freq[9,3]`); Physical Sciences (FOR = `r FOR_freq[2,1]`,
<em>n</em> = `r FOR_freq[2,3]`); and Psychology and Cognitive Sciences (FOR = 
`r FOR_freq[15,1]`, <em>n</em> = `r FOR_freq[15,3]`) as their own discipline 
groupings. The breakdown for the number of respondents according to discpline 
groupings is displayed in the next table.
  
<em>I AM SURE YOU WILL ALL AGREE THAT WE DON'T NEED THESE TWO PARAGRAPHS IN THE 
MAIN TEXT, BUT LEAVING IT FOR NOW TO MAKE SURE WE UNDERSTAND HOW EVERYTHING WAS 
GROUPED TOGETHER.</em> :)

```{r discipline_table, echo=FALSE, warning=TRUE}

d2 <- df %>% 
  dplyr::count(discipline) %>% 
   mutate (Percentage = round (n/nrow(df)*100))

# specify the exact order of the columns based on d3 (select them according to the order
  # of the rows in the tibble)
d3 <-d2 [c(4,8,10,3,5,1,2,9,7,6),]

d3 %>% 
knitr::kable(col.names = c("Disciplines", "Frequency", "Percentage"), 
             caption = sprintf("Discipline Groupings of Respondents (n = %d)",nrow(df)), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

# grouping the stem & non-stem disciples together in a new variable
df <- df %>% 
  mutate (assh = ifelse 
          (discipline %in% c ("Business & Law", "ASSH"), "ASSH", "STEM"))

```
  
```{r crisis_by_estimate, include = FALSE}

# filter rows with valid responses 
valid_rep_est <- filter(df, RepEstimate != "NA")

# calculate number of rows with a valid response 
nvalid_rep_est <- nrow(valid_rep_est)

# filter rows with valid responses for CRISIS & rename variable accordingly
nvalid_crisis <- filter(df, crisis != "NA") %>% 
  nrow()


per_crisis <- perc(x = df$crisis, y = nvalid_crisis)  #percentage per level 
# divided by number of valid cases for the crisis variable

# output of `per_crisis` inserted in text below
```

# Estimates of Reproducibility by Perceived Crisis  

Participants were asked if they believed their field is experiencing a
"reproducibility crisis". Of the `r nvalid_crisis` respondents who answered this 
question, `r per_crisis[1]`% indicated that they didn't know if there was a crisis, 
`r per_crisis[2]`% indicated there was no crisis, `r per_crisis[4]`% indicated that 
there was a slight crisis, and `r per_crisis[3]`% that there was a significant 
reproducibility crisis in their field.   

Participants were also asked to estimate the percentage of research publications 
their field that are reproducible. In the figure below, we plotted participants' 
reproducibility estimates according to their responses to the perceived 
crisis in their field. The black bar is the mean estimate of reproducibility 
perceived crisis. 

```{r crisis_by_estimate_stripchart, echo = FALSE, include = TRUE}

#estimates of reproducibility by levels of crisis as a stripchart 

title = sprintf("Estimates of reproducibility by perceived crisis in field (n = %d)",nvalid_rep_est)
x_name = "Do you think your field is experiencing a 'Reprodubility Crisis'?"
x_labels = c("Don't Know", "No Crisis", "Slight Crisis", "Significant Crisis")
y_name = "Estimated % of reproducible studies"

p <- ggplot(data = valid_rep_est, 
       aes(x=crisis, y=RepEstimate)) + 
  geom_jitter(position=position_jitter(height=0,width=.15),
              fill="blue",
              colour="blue",
              size = 2.2,
              alpha=.5) +
  stat_summary(fun.y=mean,
               fun.ymin=mean,
               fun.ymax=mean,
               geom='crossbar',
               width=0.5) +
  scale_x_discrete(name = x_name, limits = x_labels) +
  scale_y_continuous(name = y_name) +
  coord_cartesian(ylim = c(0,100)) +
  theme_classic (base_size = 12) +
  ggtitle(title)

p

# code to save it in the figs folder. Increase 'base_size' from 12 to 18 for slides. 
# ggsave(here::here("figs", "reprod_estimates_by_crisis.png"), plot = p)
```
  
   
# Experience with Open Science Practices

  
## Overall Experience with Open Science Practices

```{r os_experience, include = FALSE, warning=TRUE}

# filter rows with valid response for this variable & rename variable accordingly

valid_os_exp <- filter(df, OverallExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_os_exp <- nrow(valid_os_exp)

# create tibble with frequencies & percentages 

os_exp <- valid_os_exp %>% 
  dplyr::count(OverallExp) %>% 
  mutate(Percentage = round (n/(nrow(valid_os_exp))*100)) %>% 
  dplyr::arrange(desc(n))

```

Before we asked participants about their experience with open science practices, 
we explained that the practices enveloped by the umbrella term of "open science" 
were study preregistration, open materials and/or code, open data, pre-publication
archiving, and open access publishing.   

The figure below shows participants' experience with open science practices in
general. Of the `r nvalid_os_exp` participants who answered this question, 
`r os_exp[3,2]` (`r os_exp[3,3]`%) reported that they were unaware of open 
science practices; `r os_exp[1,2]` (`r os_exp[1,3]`%) reported that they were 
aware of open science practices, but had not used them; `r os_exp[2,2]` 
(`r os_exp[2,3]`%) reported that they had some experience with open science
practices; and only `r os_exp[4,2]` (`r os_exp[4,3]`%) reported that they had
extensive experience with open science practices. 

```{r os_experience_bar, echo=FALSE, warning=TRUE, eval = FALSE}

title = sprintf("Experience with open science practices (n = %d)",nvalid_os_exp)
x_name = "What is your experience with open science practices?"
x_labels = c("Unaware", "Aware, But Not Used", "Some Experience", "Extensive Experience")
y_name = "Frequency"

p <- ggplot(data = valid_os_exp, 
       aes(x = OverallExp)) + 
  geom_bar(
  colour = "black" , 
  fill = "blue") +
  scale_x_discrete(name = "What is your experience with open science practices?",
                   limits=c("Unaware", "Aware, But Not Used", "Some", "Extensive")) + 
  theme_classic(base_size = 12) +
  scale_y_continuous(name = "Frequency") +
  coord_cartesian(ylim = c(0,100)) +
  ggtitle(title)
p

# ggsave(here::here("figs", "os_overallexp_bar.png"))



```


```{r os_experience_pie, echo = FALSE}

title = "What is your experience with open science practices? (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = df, label_var = "OverallExp",
                      the_title = title, 
                      colours,
                      the_quantity = "percent")
p
```

```{r tables_os_experience, echo = FALSE, eval = TRUE}

tb_os_exp <-os_exp [c(3,1,2,4),] # rearrange the responses

tb_os_exp %>% 
knitr::kable(col.names = c("Reported Experience", "Frequency", "Percentage"), 
             caption = sprintf("Overall Experience with Open Science Practices (n = %d)",
                               nvalid_os_exp), align = 'lcc')  %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

# the align parameter changes how the columns are aligned. l = left; c = centre

```

## Complete Picture of Perceived Importance and Reported Experience

This gives a solid picture of the overall situation in terms of perceived importance.

### Importance of Practices

```{r stacked_imp_data, eval=TRUE, include=FALSE}
## Figure out what the data needs to look like...

# try creating tibbles for each variable that I can join? 
 # filter out irrelevant responses, but keep NAs for now
  # for some reason this only works on the character vector NOT factors

# PreReg

a <- df %>% 
  select(c("ParticipantNumber", "PreRegImp", "FORcode_2_label")) %>% 
  filter(PreRegImp != "Researchers in my discipline do not conduct research studies") %>% 
    mutate_if(is.character, ~factor(.))

# CodeImp

b <- df %>% 
  select(c("ParticipantNumber", "CodeImp", "FORcode_2_label")) %>% 
  filter(CodeImp != "Researchers in my discipline do not use materials and/or code") %>% 
  mutate_if(is.character, ~factor(.))

# DataImp

c <- df %>% 
  select(c("ParticipantNumber", "DataImp", "FORcode_2_label")) %>% 
  filter(DataImp != "Research publications in my field are not based on data") %>% 
    mutate_if(is.character, ~factor(.))

# PrePubImp

d <- df %>% 
  select(c("ParticipantNumber", "PrePubImp", "FORcode_2_label")) %>% 
  mutate_if(is.character, ~factor(.))

# join the tibbles together

df_imp <- a %>% full_join(b) %>% full_join(c) %>% full_join(d)

# only keep those responses from folks who answered at least one of the questions

valid_df_imp <- df_imp %>% 
  filter_at(vars(ends_with("Imp")), any_vars(!is.na(.)))

# now I need to make this long

imp_long <- valid_df_imp %>% 
  pivot_longer(c(ends_with("Imp")),
               names_to = "Practice", 
               values_to = "Importance") %>% 
    mutate_if(is.character, ~factor(.))

total_n <- length(unique(imp_long$ParticipantNumber))

tb <- imp_long %>% 
  group_by(Practice) %>% 
  dplyr::count(Importance) %>% 
  mutate(Percentage = round (n/(total_n)*100))

# if I make the na explicit, I can't use grey for the NA value in the 
  # brewer scale, so just stick with this...

# tb$Importance <- forcats::fct_explicit_na(tb$Importance, na_level = "N/A")

```

```{r stacked_imp_bar, eval=TRUE, warning=TRUE, echo=FALSE}
# Relevel my importance factors

tb$Importance <- factor (tb$Importance, levels = c("Extremely important",
                                           "Somewhat important", 
                                           "Somewhat unimportant",
                                           "Not at all"))
tb$Practice <- factor (tb$Practice, levels = c("PrePubImp", 
                                               "DataImp", 
                                               "CodeImp", 
                                               "PreRegImp"))

# plot the graph

title = sprintf("Perceived importance of open science\n practices (n = %d)", total_n)

p <- ggplot(tb, aes(fill = Importance, y = Percentage, x = Practice)) +
  geom_bar(position="fill", stat="identity", colour = "black") +
  scale_fill_brewer(palette = "Blues", na.value = "grey50", direction = -1) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
    theme_classic(base_size = 12) +
    theme(plot.title = element_text(hjust = 0.5)) + 
  coord_flip() +
  scale_x_discrete(labels = c("Pre-publication\n Archiving", "Open Data", "Open\n Materials/Code", "Preregistration")) +
  scale_y_continuous(labels = c("0", "25", "50", "75", "100"))

p
```


```{r stacked_imp_table, eval=FALSE,echo=FALSE}

# Relevel my importance factors
tb$Importance <- factor (tb$Importance, levels = c("Extremely important",
                                           "Somewhat important", 
                                           "Somewhat unimportant",
                                           "Not at all"))
tb$Practice <- factor (tb$Practice, levels = c("PrePubImp", 
                                               "DataImp", 
                                               "CodeImp", 
                                               "PreRegImp"))


tb %>% 
knitr::kable (col.names = c("Practice", "Perceived Importance", "Frequency",
                            "Percentage"), 
              caption = 
                sprintf("Perceived Importance of Open Science Practices <br> (n = %d)",
                                total_n), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Experience with Practices

This shows the overall situation in terms of reported experience with the various practices.

```{r stacked_exp_data, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}

## Figure out what the data needs to look like...

# try creating tibbles for each variable that I can join? 
 # filter out irrelevant responses, but keep NAs for now
  # for some reason this only works on the character vector NOT factors

# PreReg

a <- df %>% 
  select(c("ParticipantNumber", "PreRegExp", "FORcode_2_label")) %>% 
  filter(PreRegExp != "Researchers in my discipline do not conduct research studies") %>% 
    mutate_if(is.character, ~factor(.))

# CodeExp

b <- df %>% 
  select(c("ParticipantNumber", "CodeExp", "FORcode_2_label")) %>% 
  filter(CodeExp != "Researchers in my discipline do not use materials and/or code") %>% 
  mutate_if(is.character, ~factor(.))

# DataExp

c <- df %>% 
  select(c("ParticipantNumber", "DataExp", "FORcode_2_label")) %>% 
  filter(DataExp != "Research publications in my field are not based on data") %>% 
    mutate_if(is.character, ~factor(.))

# PrePubExp

d <- df %>% 
  select(c("ParticipantNumber", "PrePubExp", "FORcode_2_label")) %>% 
  mutate_if(is.character, ~factor(.))

# join the tibbles together

df_exp <- a %>% full_join(b) %>% full_join(c) %>% full_join(d)

# only keep those responses from folks who answered at least one of the questions

valid_df_exp <- df_exp %>% 
  filter_at(vars(ends_with("Exp")), any_vars(!is.na(.)))

# now I need to make this long

exp_long <- valid_df_exp %>% 
  pivot_longer(c(ends_with("Exp")),
               names_to = "Practice", 
               values_to = "Experience") %>% 
    mutate_if(is.character, ~factor(.))

total_n <- length(unique(exp_long$ParticipantNumber))

tb <- exp_long %>% 
  group_by(Practice) %>% 
  dplyr::count(Experience) %>% 
  mutate(Percentage = round (n/(total_n)*100))

```

```{r stacked_exp_bar, eval=TRUE, warning=TRUE, echo=FALSE}
# Relevel my Experience factors

# Different labels used for various practices, so I need to relabel

tb <- tb %>%  dplyr::mutate(Experience = fct_recode (Experience, 
                            "Extensive Experience" = "Regular Use",
                            "Extensive Experience" = "Reg Use",
                            "Some Experience" = "Some Use"))

tb$Experience <- factor (tb$Experience, levels = c("Extensive Experience",
                                           "Some Experience", 
                                           "Aware, But Not Used",
                                           "Unaware"))
tb$Practice <- factor (tb$Practice, levels = c("PrePubExp", 
                                               "DataExp", 
                                               "CodeExp", 
                                               "PreRegExp"))

# plot the graph

title = sprintf("Reported experience with open science\n practices (n = %d)", total_n)

p <- ggplot(tb, aes(fill = Experience, y = Percentage, x = Practice)) +
  geom_bar(position="fill", stat="identity", colour = "black") +
  scale_fill_brewer(palette = "Blues", na.value = "grey50", direction = -1, 
                    labels =c("Extensive experience","Some experience", "Aware, but not used", "Unaware", "N/A")) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
    theme_classic(base_size = 12) +
    theme(plot.title = element_text(hjust = 0.5)) + 
  coord_flip() +
  scale_x_discrete(labels = c("Pre-publication\n Archiving", "Open Data", "Open\n Materials/Code", "Preregistration")) +
  scale_y_continuous(labels = c("0", "25", "50", "75", "100"))
  
p
```

### Barriers to Open Science Practices

```{r os_barriers_data, eval=TRUE, echo=FALSE, warning=TRUE}

# wrangle this data so it's in long form & only includes endorsements.

OSBarrier_long <- df %>% 
     select(c("ParticipantNumber", 
              "OSBarrier_noOAFunding":"OSBarrier_noExpertise", 
              "FORcode_2_label")) %>%  
    select(-"OSBarrier_text") %>% 
     pivot_longer(c("OSBarrier_noOAFunding":"OSBarrier_noExpertise"), 
     names_to = "OSBarrier", 
     values_to = "OSBarrier_Endorsement") %>% 
  filter(OSBarrier_Endorsement == "1")  

# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "OSBarrier") %>% 
    filter(NewVariable != "OSBarrier_text") #remove this value from metadata

d <- full_join(OSBarrier_long, c, by = c("OSBarrier" = "NewVariable")) %>% 
  rename ("OSBarrier_label" = "ItemTextShort")

# getting a tibble for the counts
c_osbarrier <- plyr::count(d$OSBarrier)

# to figure out how many respondents shared concerns calculate unique number of participants
n_osbarrier <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(OSBarrier_label) %>% 
  mutate(Percentage = round (n/n_osbarrier*100)) %>% 
  dplyr::arrange(desc(n))

```

We provided the respondents with a list of possible barriers to the uptake of
scientific practices. We asked them to endorse any statement that they agree is 
a barrier in their field. The graph below shows the percentage of the 
`r n_osbarrier` respondents who selected each response.

```{r os_barrier_bar, echo=FALSE, eval=TRUE, fig.height = 6, fig.width=10}

# it's a really big graph, so I'm setting the figure height in the r chunk
# reorder the response options from lowest to highest, with no barriers last

tb2 <- tb %>% 
  dplyr::mutate(OSBarrier_label = factor (OSBarrier_label,
                                levels = c("Other", #TOP TO BE BOTTOM
                                "The OS community is intimidating",
                                "Researchers don't want to be told how to do their research",
                               "Researchers are discouraged from engaging in OS by colleagues",
                               "HDR students are discouraged from engaging in OS by thesis supervisors",
                               "Lack of interest from researchers",
                               "Lack of supporting infrastructure (e.g., open data platforms)",
                               "Lack of expertise to engage in OS (e.g., assignment of metadata)", 
                               "Lack of mandates from funders, institutions or other regulators",
                               "Lack of time to learn OS",
                               "Lack of time to engage in OS",
                               "Lack of information about OS",
                               "Lack of recognition in my field about the value of OS",
                               "Lack of professional staff that provide support for OS",
                               "Lack of training required to implement OS",
                               "Lack of institutional credit for engaging in OS",
                               "Lack of research funding to support OS",
                               "Lack of funding for open access publishing",
                                "I do not perceive any barriers"))) #BOTTOM TO BE TOP


# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "grey50")

# build the bar chart
title = sprintf("Barriers to uptake of open science\n in your field (n = %d)", n_osbarrier)

# plot the reordered data and colours. Because the data is in a tibble rather than 
  # a dataframe with counts, I could use 'geom_col' rather than 'geom_bar' 
  # (or I could use stat = "identity" with 'geom_bar')

p <- ggplot(tb2) + 
  aes(x = OSBarrier_label, y = Percentage) +
   geom_bar(stat = "identity", colour = "black", fill = cols) +
    labs (x = element_blank(),
      y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,80)) +
  theme_classic(base_size = 12) + 
  scale_x_discrete(labels = function(x) str_wrap(x, width = 75)) + #wrap the labels
  theme(plot.title = element_text(hjust = 0.5)) 
p



```

# Experience with different types of open science practices
   
Next, we break down the results according to their experience with specific types 
of open science practices. 

## Study Preregistration

We defined study preregistration for our participants as: "Documenting and submitting
to a journal or public repository one's research questions, methodological design, 
and anlysis plan prior to analysing the data. This time-stamped document is made
openly available by the time the research is published so that any deviation from 
the original research plan is visible to the scientific community."

### Perceived Importance of Preregistration 

```{r prereg_imp_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable; first df contains all valid 
  # responses; the second df contains all valid responses, except 
  # "Researchers in my discipline...do not conduct research studies"

valid_prereg_imp <- filter(df, PreRegImp != "NA")
valid_prereg_imp_ex <- filter(valid_prereg_imp, PreRegImp != "Researchers in my discipline do not conduct research studies")

# calculate number of rows with a valid response for these variables
nvalid_prereg_imp <- nrow(valid_prereg_imp)
nvalid_prereg_imp_ex <- nrow(valid_prereg_imp_ex)

# create a tibble with frequency & percentage for all who answered question
tb <- valid_prereg_imp %>% 
  dplyr::count(PreRegImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_prereg_imp))*100)) %>% 
  dplyr::arrange(desc(n))

# create a tibble with frequency & percentage for data excluding "do not use"
tb_ex <- valid_prereg_imp_ex %>% 
  dplyr::count(PreRegImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_prereg_imp_ex))*100)) %>% 
  dplyr::arrange(desc(n))

```

We first asked participants how important preregistration of studies is for their field. 
Of the `r nvalid_prereg_imp` participants who answered this question, a small percentage 
(`r tb[5,3]`%) indicated that researchers in their discipline do not conduct 
research studies. As such, we excluded them from this analysis. Of the remaining 
`r nvalid_prereg_imp_ex` respondents, `r tb_ex[3,2]` (`r tb_ex[3,3]`%) indicated that 
preregistration was extremely important for their field; `r tb_ex[1,2]` (`r tb_ex[1,3]`%)
indicated that it was somewhat important; `r tb_ex[4,2]` (`r tb_ex[4,3]`)% indicated 
that preregistration was somewhat unimportant; and `r tb_ex[2,2]` (`r tb_ex[2,3]`%)
indicated that it was not at all important for their field. 

```{r prereg_imp_ex_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "Perceived Importance of Preregistration (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = valid_prereg_imp_ex, label_var = "PreRegImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r prereg_imp_ex_table, echo=FALSE, warning=TRUE}

tb_ex2 <- tb_ex [c(2,4,1,3),]  # rearrange the responses

tb_ex2 %>% 
knitr::kable (col.names = c("Perceived Importance", "Frequency",
                            "Percentage"), 
              caption = 
                sprintf("Perceived Importance of Preregistration <br> (n = %d)",
                                nvalid_prereg_imp_ex), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Experience with Study Preregistration

```{r prereg_exp_count, echo = FALSE, warning=TRUE}
# filter rows with valid responses for this variable
valid_prereg_exp <- filter(df, PreRegExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_prereg_exp <- nrow(valid_prereg_exp)

# create a tibble with frequency & percentage for all who answered question
tb <- valid_prereg_exp %>% 
  dplyr::count(PreRegExp) %>% 
  mutate(Percentage = round (n/(nrow(valid_prereg_exp))*100)) %>% 
  dplyr::arrange(desc(n))

```

We then asked respondents about their own experience with study preregistration. 
Of the `r nvalid_prereg_exp` participants who answered this question, `r tb[1,2]`
 (`r tb[1,3]`%) were unaware of study preregistration; `r tb[2,2]` (`r tb[2,3]`%) 
were aware of study preregistration, but had not used it; `r tb[3,2]` (`r tb[3,3]`%) 
had some experience with it, but did not regularly preregister their studies; and 
`r tb[4,2]` (`r tb[4,3]`%) regularly preregister their studies. 

```{r prereg_exp_pie, echo = FALSE, warning = TRUE, eval = FALSE}

title = "What is your experience with preregistration? (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = df, label_var = "PreRegExp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
rm(title)
```

```{r prereg_exp_table, echo=FALSE, warning=TRUE}

# change the label for Regular Use
tb$PreRegExp <- tb$PreRegExp %>% 
  mapvalues(
    c("Unaware", "Aware, But Not Used", "Some Experience", "Reg Use"), 
    c("Unaware", "Aware, But Not Used", "Some Experience", "Regular Use"))

tb2 <- tb[c(1,2,3,4),] #fix order

tb2 %>% 
knitr::kable (col.names = c("Reported Experience", "Frequency", "Percentage"),
              caption = sprintf("Experience with Study Preregistration <br>(n = %d)",
                                nvalid_prereg_exp), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Concerns about Preregistration 

```{r prereg_concerns_data, echo=FALSE, warning=TRUE}

# wrangle the concern data so it's in long form & only includes endorsements.

PreRegCon_long <- df %>% 
     select(c("ParticipantNumber", "AcLevel_Label",
              "PreRegCon_delay":"PreRegCon_none", 
              "FORcode_2_label")) %>%  
    select(-"PreRegCon_text") %>% 
     pivot_longer(c("PreRegCon_delay":"PreRegCon_none"), 
     names_to = "PreRegConcern", 
     values_to = "PreReg_Endorsement") %>% 
  filter(PreReg_Endorsement == "1")  

# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "PreRegConcern") %>% 
    filter(NewVariable != "PreRegCon_text") #remove this value from metadata

d <- full_join(PreRegCon_long, c, by = c("PreRegConcern" = "NewVariable")) %>% 
  rename ("PreRegConcern_label" = "ItemTextShort")

# getting a tibble for the counts
c_prereg_con <- plyr::count(d$PreRegConcern)

# to figure out how many respondents shared concerns calculate unique number of participants
n_prereg_con <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages

tb <- d %>% 
  dplyr::count(PreRegConcern_label) %>% 
  mutate(Percentage = round (n/n_prereg_con*100)) %>% 
  dplyr::arrange(desc(n)) 

```

We also asked respondents if they have any concerns about preregistering their 
studies. After asking respondents to share their concerns in a free text format, 
we then provided a list of possible concerns that researchers could have about
preregistering their studies. 

Respondents were able to select as many concerns as they liked. Of the `r n_prereg_con`
respondents who answered this question, `r tb [7,2]` (`r tb [7,3]`%) 
reported that they do not share any of the listed concerns. The following figure 
presents, of those who answered this question, the percentage who selected 
each of the concerns.  

```{r prereg_concerns_bar, echo=FALSE, warning=TRUE}

# reorder the response options from lowest to highest, with concerns last
tb2 <- tb %>% 
  dplyr::mutate(PreRegConcern_label = factor (PreRegConcern_label, 
                                levels = c("Other concern",
                                           "More difficult to find significant results", 
                                           "More difficult to publish in certain journals", 
                                           "Delays data collection", 
                                           "Stifles creativity",  
                                           "Prevents exploratory research", 
                                           "Need to look at data to analyse it", 
                                           "Risk of scooping", 
                                           "I do not share any of these concerns")))

# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", "grey50")

# build the bar chart
title = sprintf("Concerns about preregistering studies\n (n = %d)", n_prereg_con)

# plot the reordered data and colours. Because the data is in a tibble rather than 
  # a dataframe with counts, I could use 'geom_col' rather than 'geom_bar' 
  # (or I could use stat = "identity" with 'geom_bar')

p <- ggplot(tb2) + 
  aes(x = PreRegConcern_label, y = Percentage) +
   geom_bar(stat = "identity", colour = "black", fill = cols) +
    labs (x = element_blank(),
      y = "Percentage", 
        title = title) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  coord_flip(ylim = c(0,60)) +
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) 
p

```

## Open Materials and/or Code 

The next section of the survey related to the use of open materials and/or code. 
For our purposes, we explained that open materials and/or code referred to researcher-
created resources used while collecting or analyzing data (e.g., survey questions, 
video stimuli, vignettes, algorithms, coding schemes, analytic code, etc.) that 
are made openly available to the research community.

### Perceived Importance of Open Materials and/or Code 

```{r code_imp_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable; first df contains all valid 
  # responses the second df contains all valid responses, except "Researchers...do 
  # not use materials and/or code "

valid_code_imp <- filter(df, CodeImp != "NA")
valid_code_imp_ex <- filter(valid_code_imp, CodeImp != "Researchers in my discipline do not use materials and/or code")

nvalid_code_imp <- nrow(valid_code_imp)
nvalid_code_imp_ex <- nrow(valid_code_imp_ex)

# create a tibble with frequency & percentage for all who answered question
tb <- valid_code_imp %>% 
  dplyr::count(CodeImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_code_imp))*100)) %>% 
  dplyr::arrange(desc(n))

# create a tibble with frequency & percentage for data excluding "do not use"
tb_ex <- valid_code_imp_ex %>% 
  dplyr::count(CodeImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_code_imp_ex))*100)) %>% 
  dplyr::arrange(desc(n))

```

We first asked participants how important they thought it was for their field to
make materials and/or code openly available. Of the `r sum(tb[2])` participants 
who answered this question, a small percentage (`r tb[5,3]`%) indicated 
that researchers in their discipline do not use materials and/or code. As such, 
we excluded them from this analysis. Of the remaining `r sum(tb_ex[2])` 
respondents, `r tb_ex[2,3]`% indicated that open materials and/or code were 
extremely important for their field; `r tb_ex[1,3]`% indicated that they were 
somewhat important; `r tb_ex[3,3]`% indicated that they were somewhat unimportant; 
and `r tb_ex[4,3]`% indicated that open materials and/or code were not at all 
important for their field. 


```{r code_imp_ex_pie, echo = FALSE, warning = TRUE, eval = FALSE}

title = "Perceived importance of open materials and/or code (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = valid_code_imp_ex, 
                      label_var = "CodeImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r code_imp_ex_table, echo=FALSE, warning=TRUE}

tb_ex <- valid_code_imp_ex %>% 
  dplyr::count(CodeImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_code_imp_ex))*100)) %>% 
  dplyr::arrange(desc(n))

tb_ex2 <-tb_ex [c(4,3,1,2),] # rearrange the responses

tb_ex2 %>% 
knitr::kable (col.names = c("Perceived Importance", "Frequency", "Percentage"), 
              caption = sprintf("Perceived Importance of Open Materials and/or Code (n = %d)", nvalid_code_imp_ex), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```


### Experience with Open Materials and/or Code

```{r code_exp_count, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_code_exp <- filter(df,CodeExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_code_exp <- nrow(valid_code_exp)

tb <- valid_code_exp %>% 
  dplyr::count(CodeExp) %>%  
    mutate(Percentage = round (n/nvalid_code_exp*100)) %>% 
    dplyr::arrange(desc(n))

```

The following section shows how many people have experience with open code 
and/or materials. Of the `r nvalid_code_exp` participants who answered this 
question, `r tb[1,2]` (`r tb[1,3]`%) reported that, until now, they hadn't heard 
of open materials and/or code; `r tb[2,2]` (`r tb[2,3]`%) were aware of open
materials and/or code, but had not used it in their own research; `r tb[3,2]` 
(`r tb[3,3]`%) had some experience with open materials and/or code, but do not 
use them regularly; and `r tb[4,2]` (`r tb[4,3]`%) regularly use open materials
and/or code. 

```{r code_exp_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "What is your experience with open materials and/or code (n = %d)"

#pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df,label_var="CodeExp",the_title = title, colours = colours, the_quantity="percent")
p
```


```{r code_exp_table, echo=FALSE, warning=TRUE}

tb2 <- tb [c(2,1,3,4),] # fix the order of responses

tb2 %>% 
knitr::kable (col.names = c("Reported Experience", "Frequency", "Percentage"), 
              caption = sprintf("Experience with Open Materials and/or Code (n = %d)",
                                nvalid_code_exp), align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```
### Use of Open Materials and/or Code

```{r code_use_count, echo=FALSE, warning=TRUE}

# wrangle this data so it's in long form & only includes endorsements.

CodeUse_long <- df %>% 
  select (c("ParticipantNumber", "AcLevel_Label",
            "CodeUse_useOthers":"CodeUse_peer",
            "FORcode_2_label")) %>%  
  select(-"CodeUse_text") %>% 
  pivot_longer(c("CodeUse_useOthers":"CodeUse_peer"),
               names_to = "CodeUse", 
               values_to = "CodeUse_endorsement") %>% 
  filter(CodeUse_endorsement == "1")

# recode the data so the response options have proper labels
  # there must be a way to only select the rows that "start with" a character string
  # but for now this works

c <- metadata %>% 
    filter(Scale == "CodeUse") %>% 
    filter (NewVariable != "CodeUse_text")

d <- full_join(CodeUse_long, c, by = c("CodeUse" = "NewVariable")) %>% 
  rename ("CodeUse_label" = "ItemText")

# getting a tibble for the counts
c_code_use <- plyr::count(d$CodeUse)

# to figure out how many respondents shared concerns calculate unique number of participants
n_code_use <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(CodeUse_label) %>% 
  mutate(Percentage = round (n/n_code_use*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

# AH...I only need these next two steps if I'm actually able to figure out how 
  # to use the Use variable to reorder the variable, while using the Use_label
  # variable to name the actual columns in the tables. Otherwise, skip this.

d2 <- d %>% # create tibble with the Code Use counts
  select(CodeUse, CodeUse_label)  %>% 
      dplyr::count(CodeUse) 
  #  mutate_if(is.character, ~factor(.))

# join the two tables together
tb2 <- left_join(x = tb, y = d2, by = "n") %>% 
  dplyr::arrange(desc(n))

```

For those participants who reported that they use open materials and/or code 
(that is, those who reported some use or regular use), we asked them for more 
information about how they have used open materials and/or code in previous work. 
Respondents were allowed to select as many uses as applied. Of these `r n_code_use`
researchers, the most popular response (`r tb2[1,3]`%) was that they used other 
researchers' open materials and/or code in their own research. Few researchers 
reported using open materials and/or code when peer reviewing other researchers'
work (`r tb2[4,3]`%). 

```{r code_use_table, echo=FALSE, warning=TRUE}

tb2 <-tb2 %>% select(-CodeUse) # remove the CodeUse column

tb2 %>% 
knitr::kable (col.names = c("Reported Use", "Frequency", "Percentage"), 
              caption = sprintf("Reported Use of Open Materials and/or Code (n = %d)", n_code_use), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling
```

### Concerns about Open Materials and/or Code

```{r code_concerns_data, echo=FALSE, warning=TRUE}

# wrangle this data so it's in long form & only includes endorsements.

CodeCon_long <- df %>% 
     select(c("ParticipantNumber", 
              "CodeCon_criticise":"CodeCon_ip", 
              "FORcode_2_label")) %>%  
    select(-"CodeCon_text") %>% 
     pivot_longer(c("CodeCon_criticise":"CodeCon_ip"), 
     names_to = "CodeConcern", 
     values_to = "CodeCon_Endorsement") %>% 
  filter(CodeCon_Endorsement == "1")  


# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "CodeConcern") %>% 
    filter(NewVariable != "CodeCon_text") #remove this value from metadata

d <- full_join(CodeCon_long, c, by = c("CodeConcern" = "NewVariable")) %>% 
  rename ("CodeConcern_label" = "ItemTextShort")

# getting a tibble for the counts
c_code_con <- plyr::count(d$CodeConcern)

# to figure out how many respondents shared concerns calculate unique number of participants
n_code_con <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(CodeConcern_label) %>% 
  mutate(Percentage = round (n/n_code_con*100)) %>% 
  dplyr::arrange(desc(n))

```

We also asked respondents if they have any concerns about making their research 
materials and/or code open. After asking respondents to share their concerns in 
a free text format, we provided a list of possible concerns that researchers 
could have about sharing their materials and/or code. Respondents were able to 
select as many concerns as they liked. A total of `r n_code_con` respondents 
answered this question. Of those who respondended to this question,
`r tb [4,2]` (`r tb [4,3]`%) reported that they do not share any of the listed 
concerns. The following figure presents, of those who answered this question, 
the percentage who selected each of the concerns.  

```{r code_concerns_bar, echo=FALSE, warning=TRUE}
# build the bar chart

# reorder the response options from lowest to highest, with concerns last
tb2 <- tb %>% 
  dplyr::mutate(CodeConcern_label = factor (CodeConcern_label, 
                levels = c("Other concern",
                         "Others might find errors in my published work", 
                         "Reuse could violate epistemological framework", 
                         "Others might ask me to provide assistance with their research", 
                         "Others might criticise my materials/code", 
                        "Others might find it difficult to understand my materials/code", 
                         "I might lose control over how they are used", 
                         "I might not receive appropriate credit", 
                         "Issues related to intellectual property", 
                         "I do not share any of these concerns")))

# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "grey50")

# build the bar chart
title = sprintf("Concerns about open materials\n and/or code (n = %d)", n_code_con)

# plot the reordered data and colours. Because the data is in a tibble rather than a     
  # dataframe with counts, I could use 'geom_col' rather than 'geom_bar'(or I 
  # could use stat = "identity" with 'geom_bar')

p <- ggplot(tb2) + 
  aes(x = CodeConcern_label, y = Percentage) +
  geom_bar(stat = "identity", colour = "black", fill = cols) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,60)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) # centre the title
p

```

## Open Data

The next section of the survey related to the use of open data. 
For our purposes, we explained that open data can be defined as "online, free of 
cost, accessible data that can be used, reused and distributed provided that the 
data source is attributed and shared alike." [FIND SOURCE FROM SURVEY]

### Perceived Importance of Open Data 

```{r data_imp_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable; first df contains all valid 
  # responses the second df contains all valid responses, except "Researchers...do 
  # not use materials and/or code "

valid_data_imp <- filter(df, DataImp != "NA")
valid_data_imp_ex <- filter(valid_data_imp, DataImp != "Research publications in my field are not based on data")

nvalid_data_imp <- nrow(valid_data_imp)
nvalid_data_imp_ex <- nrow(valid_data_imp_ex)

# create a tibble with frequency & percentage for all who answered question
tb <- valid_data_imp %>% 
  dplyr::count(DataImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_data_imp))*100)) %>% 
  dplyr::arrange(desc(n))

# create a tibble with frequency & percentage for data excluding "do not use"
tb_ex <- valid_data_imp_ex %>% 
  dplyr::count(DataImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_data_imp_ex))*100)) %>% 
  dplyr::arrange(desc(n))

```

We first asked participants how important they thought it was for their field that 
data from published research are openly available. Of the `r sum(tb[2])` participants 
who answered this question, a small number `r tb[5,2]` (`r tb[5,3]`%) indicated that
`r tolower(tb[5,1])`. As such, we excluded them from this analysis. Of the 
remaining `r sum(tb_ex[2])` respondents, `r tb_ex[1,2]` (`r tb_ex[1,3]`%) indicated 
that open data were `r tolower(tb_ex[1,1])` for their field; `r tb_ex[2,2]` 
(`r tb_ex[2,3]`%) indicated that they were `r tolower(tb_ex[2,1])`; `r tb_ex[3,2]` 
(`r tb_ex[3,3]`%) indicated that they were `r tolower(tb_ex[3,1])`; 
and `r tb_ex[4,2]` (`r tb_ex[4,3]`%) indicated that open data were `r tolower(tb_ex[4,1])` 
important for their field. 

```{r data_imp_ex_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "Perceived importance of open data (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = valid_data_imp_ex, 
                      label_var = "DataImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```

```{r data_imp_ex_table, echo=FALSE, warning=TRUE}

tb_ex <- valid_data_imp_ex %>% 
  dplyr::count(DataImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_data_imp_ex))*100)) %>% 
  dplyr::arrange(desc(n))

tb_ex2 <-tb_ex [c(4,3,2,1),] # rearrange the responses

tb_ex2 %>% 
knitr::kable (col.names = c("Perceived Importance", "Frequency", "Percentage"), 
              caption = sprintf("Perceived Importance of Open Data (n = %d)", nvalid_data_imp_ex), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```


### Experience with Open Data

```{r data_exp_count, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_data_exp <- filter(df,DataExp != "NA")

# FIGURING OUT WHICH PARTICIPANTS SAID THE VARIOUS RESPONSES

# dataexp <- df %>% 
  # filter(DataExp == "Aware, But Not Used") %>% 
  # select(ParticipantNumber, DataExp, DataConcernsList)
# write.csv(test, here::here("data", "DataExp.csv"), row.names = TRUE)

# calculate number of rows with a valid response for this variable
nvalid_data_exp <- nrow(valid_data_exp)

tb <- valid_data_exp %>% 
  dplyr::count(DataExp) %>%  
    mutate(Percentage = round (n/nvalid_data_exp*100)) %>% 
    dplyr::arrange(desc(n))

```

We also asked participants about their experience with open data. Of the 
`r sum(tb[2])` participants who answered this question, `r tb[4,2]` (`r tb[4,3]`%) 
indicated that until now, they were unaware of open data; `r tb[1,2]` 
(`r tb[1,3]`%) indicated that they were were aware of open data, but had not used
it in their research; `r tb[2,2]` (`r tb[2,3]`%) indicated that they had some 
experience with open data, but did not use them regularly; and `r tb[3,2]` 
(`r tb[3,3]`%) indicated that they regularly use open data. 

```{r data_exp_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "What is your experience with open data? (n = %d)"

#pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df,label_var="DataExp",the_title = title, colours = colours, the_quantity="percent")
p
```


```{r data_exp_table, echo=FALSE, warning=TRUE}

tb2 <- tb [c(4,1,2,3),] # fix the order of responses from 'unaware' to 'reg use'

tb2 %>% 
knitr::kable (col.names = c("Reported Experience", "Frequency", "Percentage"), 
              caption = sprintf("Experience with Open Data (n = %d)",
                                nvalid_data_exp), align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Use of Open Data

```{r data_use_count, echo=FALSE, warning=TRUE}

# wrangle this data so it's in long form & only includes endorsements.

DataUse_long <- df %>% 
  select (c("ParticipantNumber", "AcLevel_Label",
            "DataUse_useOthers":"DataUse_text",
            "FORcode_2_label")) %>%  
  select(-"DataUse_text") %>% 
  pivot_longer(c("DataUse_useOthers":"DataUse_other"),
               names_to = "DataUse", 
               values_to = "DataUse_endorsement") %>% 
  filter(DataUse_endorsement == "1")

# recode the data so the response options have proper labels
  # there must be a way to only select the rows that "start with" a character string
  # but for now this works

c <- metadata %>% 
    filter(Scale == "DataUse") %>% 
    filter (NewVariable != "DataUse_text")

d <- full_join(DataUse_long, c, by = c("DataUse" = "NewVariable")) %>% 
  rename ("DataUse_label" = "ItemText")

# getting a tibble for the counts
c_data_use <- plyr::count(d$DataUse)

# to figure out how many respondents shared concerns calculate unique number of participants
n_data_use <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(DataUse_label) %>% 
  mutate(Percentage = round (n/n_data_use*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

# AH...I only need these next two steps if I'm actually able to figure out how 
  # to use the Use variable to reorder the variable, while using the Use_label
  # variable to name the actual columns in the tables. Otherwise, skip this.

d2 <- d %>% # create tibble with the Data Use counts
  select(DataUse, DataUse_label)  %>% 
      dplyr::count(DataUse) 
  #  mutate_if(is.character, ~factor(.))

# join the two tables together
tb2 <- left_join(x = tb, y = d2, by = "n") %>% 
  dplyr::arrange(desc(n))



```

For those participants who reported that they use open data (that is, those who 
reported some use or regular use), we asked them for more information about how 
they have used open data in previous work. Respondents were allowed to select 
as many uses as applied. Of these `r n_data_use` researchers, the most popular 
response (`r tb[1,3]`%) was that they used open data from other sources in their 
own research. Few researchers reported using open data when peer reviewing other 
researchers'work (`r tb2[4,3]`%).

```{r data_use_table, echo=FALSE, warning=TRUE}

tb %>% 
knitr::kable (col.names = c("Reported Use", "Frequency", "Percentage"), 
              caption = sprintf("Reported Use of Open Data (n = %d)", n_data_use), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling
```

### Concerns about Open Data

```{r data_concerns_data, echo=FALSE, warning=TRUE, eval = TRUE}

# wrangle this data so it's in long form & only includes endorsements.

DataConcern_long <- df %>% 
  select (c("ParticipantNumber", "AcLevel_Label",
            "DataConcern_criticise":"DataConcern_scoop",
            "FORcode_2_label")) %>%  
  select(-"DataConcern_text") %>% 
  pivot_longer(c("DataConcern_criticise":"DataConcern_scoop"),
               names_to = "DataConcern", 
               values_to = "DataConcern_Endorsement") %>% 
  filter(DataConcern_Endorsement == "1")

# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "DataConcern") %>% 
    filter(NewVariable != "DataConcern_text") #remove this value from metadata

d <- full_join(DataConcern_long, c, by = c("DataConcern" = "NewVariable")) %>% 
  rename ("DataConcern_label" = "ItemTextShort")

# getting a tibble for the counts
c_data_con <- plyr::count(d$DataConcern)

# to figure out how many respondents shared concerns calculate unique number of participants
n_data_con <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(DataConcern_label) %>% 
  mutate(Percentage = round (n/n_data_con*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

# AH...I only need these next two steps if I'm actually able to figure out how 
  # to use the `x` variable to reorder the variable, while using the `x_label`
  # variable to name the actual columns in the tables. Otherwise, skip this.

d2 <- d %>% # create tibble with the Data Concern counts
  select(DataConcern, DataConcern_label)  %>% 
      dplyr::count(DataConcern) 
  #  mutate_if(is.character, ~factor(.))

# join the two tables together
tb2 <- left_join(x = tb, y = d2, by = "n") 
```

We also asked respondents if they have any concerns about making their data open.
After asking respondents to share their concerns in a free text format, we 
provided a list of possible concerns that researchers could have about sharing 
their data. Respondents were able to select as many concerns as they liked. 
A total of `r n_data_con` respondents answered this question. Of those who respondended,
`r tb2 [11,2]` (`r tb2 [11,3]`%) reported that they do not share any of the listed 
concerns. The following figure presents, of those who answered this question, 
the percentage who selected each of the concerns.  

```{r data_concerns_bar, echo=FALSE, warning=TRUE, eval=TRUE}

# build the bar chart

# reorder the rows according to the DataConcern_label 
tb3 <- tb2 %>% 
  dplyr::mutate(DataConcern_label = factor(DataConcern_label, 
                levels = c("Other concern", 
                           "It devalues research data collection", 
                           "Unfair for other researchers to benefit from my data collection", 
                          "Others might criticise my data and/or research practices", 
                           "Too much time or effort", 
                           "I might lose control over how my data are being used",
                           "I might not receive appropriate credit for my data collection", 
                           "Others could use my data for another study that I intended to conduct in the future", 
                           "Issues related to intellectual property", 
                           "Issues related to privacy", 
                           "Issues related to ethics", 
                           "I do not share any of these concerns")))



# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "grey50")

                    
# build the bar chart
title = sprintf("Concerns about open data (n = %d)", n_data_con)

p <- ggplot(tb3) + 
  aes(x = DataConcern_label, y = Percentage) +
  geom_bar(stat = "identity", colour = "black", fill = cols) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,60)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) # centre the title
p

```

## Pre-publication Archiving

The next section of the survey related to the use of pre-publication archiving. 
For our purposes, we explained that pre-publication archiving is also known as 
preprint archiving, and refers to making a manuscript openly available <em><b>
before </em></b> it undergoes peer review in an academic journal or other outlet.
Generally, this is achieved by uploading the manuscript to an archive such as arXiv
(physics, maths), bioRxiv (biology), SocArxiv (sociology), etc.

### Perceived Importance of Pre-publication Archiving 

```{r prepub_imp_count, echo = FALSE, warning=TRUE}

# filter rows with valid responses for this variable

valid_prepub_imp <- filter(df, PrePubImp != "NA")

nvalid_prepub_imp <- nrow(valid_prepub_imp)

# create a tibble with frequency & percentage for all who answered question
tb <- valid_prepub_imp %>% 
  dplyr::count(PrePubImp) %>% 
  mutate(Percentage = round (n/(nrow(valid_prepub_imp))*100)) %>% 
  dplyr::arrange(desc(n))

```

We first asked participants how important they thought pre-publication archiving
was for their field. Of the `r sum(tb[2])` participants who answered this 
question `r tb[4,2]` (`r tb[4,3]`%) indicated 
that pre-publication archiving was `r tolower(tb[4,1])` for their field; 
`r tb[1,2]` (`r tb[1,3]`%) indicated that it was `r tolower(tb[1,1])`; 
`r tb[2,2]` (`r tb[2,3]`%) indicated that it was `r tolower(tb[2,1])`; 
and `r tb[3,2]` (`r tb[3,3]`%) indicated that pre-publication archiving was 
`r tolower(tb[3,1])` important for their field. 

```{r prepub_imp_ex_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "Perceived importance of pre-publication archiving (n = %d)"

# pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(the_data = valid_prepub_imp, 
                      label_var = "PrePubImp", 
                      the_title = title, 
                      colours,the_quantity = "percent")
p
```


```{r prepub_imp_table, echo=FALSE, warning=TRUE}

tb2 <-tb [c(3,2,1,4),] # rearrange the responses from 'not at all' to 'ext imp'

tb2 %>% 
knitr::kable (col.names = c("Perceived Importance", "Frequency", "Percentage"), 
              caption = sprintf("Perceived Importance of Pre-publication Archiving (n = %d)", nvalid_prepub_imp), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Experience with Pre-publication Archiving

```{r prepub_count_exp, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_prepub_exp <- filter(df,PrePubExp != "NA")

# calculate number of rows with a valid response for this variable
nvalid_prepub_exp <- nrow(valid_prepub_exp)

tb <- valid_prepub_exp %>% 
  dplyr::count(PrePubExp) %>%  
    mutate(Percentage = round (n/nvalid_prepub_exp*100)) %>% 
    dplyr::arrange(desc(n))

```

We also asked participants about their experience with pre-publication archiving. 
Of the `r sum(tb[2])` participants who answered this question, `r tb[2,2]` 
(`r tb[2,3]`%) indicated that until now, they were unaware of pre-publication 
archiving; `r tb[1,2]` (`r tb[1,3]`%) indicated that they were were aware of pre-
publication arhciving, but had not used it; `r tb[4,2]` (`r tb[4,3]`%) indicated 
that they had some experience with pre-publication archiving; and `r tb[3,2]` 
(`r tb[3,3]`%) indicated that they have extensive experience with pre-publication
archiving. 

```{r prepub_exp_pie, echo = FALSE, warning = TRUE, eval=FALSE}

title = "What is your experience with pre-publication archiving? (n = %d)"

#pie chart
colours <- brewer.pal(4, "Blues")
p <- simple_pie_chart(df,
                      label_var="PrePubExp",
                      the_title = title, 
                      colours = colours, 
                      the_quantity="percent")
p
```

```{r prepub_exp_table, echo=FALSE, warning=TRUE}

tb2 <- tb [c(2,1,4,3),] # fix the order of responses from 'unaware' to 'ext exp'

tb2 %>% 
knitr::kable (col.names = c("Reported Experience", "Frequency", "Percentage"), 
              caption = sprintf("Experience with Pre-publication Archiving (n = %d)",
                                nvalid_prepub_exp), align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Use of Pre-publication Archiving

```{r prepub_use_count, echo=FALSE, warning=TRUE}

# wrangle this data so it's in long form & only includes endorsements.

PrePubUse_long <- df %>% 
  select (c("ParticipantNumber", "AcLevel_Label",
            "PrePubUse_upload":"PrePubUse_read",
            "FORcode_2_label")) %>%  
  select(-"PrePubUse_text") %>% 
  pivot_longer(c("PrePubUse_upload":"PrePubUse_read"),
               names_to = "PrePubUse", 
               values_to = "PrePubUse_endorsement") %>% 
  filter(PrePubUse_endorsement == "1")

# recode the data so the response options have proper labels
  # there must be a way to only select the rows that "start with" a character string
  # but for now this works

c <- metadata %>% 
    filter(Scale == "PrePubUse") %>% 
    filter (NewVariable != "PrePubUse_text")

d <- full_join(PrePubUse_long, c, by = c("PrePubUse" = "NewVariable")) %>% 
  rename ("PrePubUse_label" = "ItemText")

# getting a tibble for the counts
c_prepub_use <- plyr::count(d$PrePubUse)

# to figure out how many respondents shared concerns calculate unique number of participants
n_prepub_use <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(PrePubUse_label) %>% 
  mutate(Percentage = round (n/n_prepub_use*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

# AH...I only need these next two steps if I'm actually able to figure out how 
  # to use the Use variable to reorder the variable, while using the Use_label
  # variable to name the actual columns in the tables. Otherwise, skip this.

d2 <- d %>% # create tibble with the Data Use counts
  select(PrePubUse, PrePubUse_label)  %>% 
      dplyr::count(PrePubUse) 
  #  mutate_if(is.character, ~factor(.))

# join the two tables together
tb2 <- left_join(x = tb, y = d2, by = "n") %>% 
  dplyr::arrange(desc(n))

```

For those participants who reported that they use pre-publication archiving (that
is, those who reported some experience or extensive experience), we asked them 
for more information about how they have used these archives. Respondents were 
allowed to select as many uses as applied. Of these `r n_prepub_use` researchers, 
the most popular response (`r tb[1,3]`%) was that they read an article from, 
searched, or browsed a pre-publication archive. That is, they used other people's 
work posted to pre-publication archives for their own purposes. The next most 
common use by these researchers is to upload their own work to a pre-publication
archive before submitting it to a journal (`r tb[2,3]`%).

```{r prepub_use_table, echo=FALSE, warning=TRUE}

tb %>% 
knitr::kable (col.names = c("Reported Use", "Frequency", "Percentage"), 
              caption = sprintf("Reported Use of Pre-publication Archiving (n = %d)", n_prepub_use), 
              align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling
```

### Concerns about Pre-publication Archiving

```{r prepub_concerns_data, echo=FALSE, warning=TRUE, eval = TRUE}

# wrangle this data so it's in long form & only includes endorsements.

PrePubConcern_long <- df %>% 
  select (c("ParticipantNumber", "AcLevel_Label",
            "PrePubConcern_policy":"PrePubConcern_none",
            "FORcode_2_label")) %>%  
  select(-"PrePubConcern_text") %>% 
  pivot_longer(c("PrePubConcern_policy":"PrePubConcern_none"),
               names_to = "PrePubConcern", 
               values_to = "PrePubConcern_Endorsement") %>% 
  filter(PrePubConcern_Endorsement == "1")

# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "PrePubConcern") %>% 
    filter(NewVariable != "PrePubConcern_text") #remove this value from metadata

d <- full_join(PrePubConcern_long, c, by = c("PrePubConcern" = "NewVariable")) %>% 
  rename ("PrePubConcern_label" = "ItemTextShort")

# getting a tibble for the counts
c_prepub_con <- plyr::count(d$PrePubConcern)

# to figure out how many respondents shared concerns calculate unique number of participants
n_prepub_con <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(PrePubConcern_label) %>% 
  mutate(Percentage = round (n/n_prepub_con*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

```

We asked all respondents if they have any concerns about uploading a manuscript
to a pre-publication archive before submitting it for peer review. After asking 
respondents to share their concerns in a free text format, we provided a list of 
possible concerns that researchers could have about engaging in this practice. 
Respondents were able to select as many concerns as they liked. A total of 
`r n_prepub_con` respondents answered this question. Of those who respondended,
`r tb [6,2]` (`r tb [6,3]`%) reported that they do not share any of the listed 
concerns. The following figure presents, of those who answered this question, 
the percentage who selected each of the concerns.  

```{r prepub_concerns_bar, echo=FALSE, warning=TRUE, eval=TRUE}

# build the bar chart

# reorder the rows according to the PrePubConcern_label 
tb2 <- tb %>% 
  dplyr::mutate(PrePubConcern_label = factor(PrePubConcern_label, 
                levels = c("Other concern", 
                           "Others could see differences between the original conception and the ultimately published work",
                           "Making my work available pre-publication might reduce citations of the ultimately published work",
                           "Other people might copy my research and publish it before I do",
                            "Non-peer-reviewed findings might add noise to the literature",
                           "Some journals might not publish the uploaded manuscript",
                           "I do not share any of these concerns")))

# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", "grey50")
                    

# build the bar chart
title = sprintf("Concerns about pre-publication archiving\n (n = %d)", n_prepub_con)

p <- ggplot(tb2) + 
  aes(x = PrePubConcern_label, y = Percentage) +
  geom_bar(stat = "identity", colour = "black", fill = cols) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,70)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) # centre the title
p

```

## Open Access Publishing

The next section of the survey addressed Open Access publishing. We first explained
the two different kinds of open access publishing: (1) paying an open access fee 
to make the final version of your published article open access, and (2) deposit 
the final accepted version of your manuscript (peer-reviewed but not 
journal-formatted) in an open access repository (e.g., Swinburne Research Bank
or bioRxiv). 

### Proportion of Publications that are Open Access 

```{r oa_prop_count, echo=FALSE, warning=TRUE}

# filter rows with valid responses for this variable
valid_OAprop <- filter(df,OAprop != "NA")

# calculate number of rows with a valid response for this variable
nvalid_OAprop <- nrow(valid_OAprop)

tb <- valid_OAprop %>% 
  dplyr::count(OAprop) %>%  
    mutate(Percentage = round (n/nvalid_OAprop*100)) %>% 
    dplyr::arrange(desc(n))

```

We asked participants to indicate approximately what proportion of their 
publications from the last 5 years are open access. Of the `r sum(tb[2])` 
participants who answered this question, the most common responses were that 
some (`r tb[1,2]`; `r tb[1,3]`%) or none (`r tb[2,2]`; `r tb[2,3]`%) of their 
publications were open access. A small proportion (`r tb[3,2]`; `r tb[3,3]`%) 
indicated that they did not know what proportion were open access. The following
table provides the breakdown of responses.

```{r oa_prop_table, echo=FALSE, warning=TRUE}

tb2 <- tb [c(3,2,1,5,4,6),] # fix the order of responses from 'i don't know' to 'all'

tb2 %>% 
knitr::kable (col.names = c("Response", "Frequency", "Percentage"), 
              caption = sprintf("Proportion of Publications that are Open Access (n = %d)",
                                nvalid_OAprop), align = 'lcc') %>% 
   kable_styling(bootstrap_options = "striped", full_width = F, 
                 position = 'center',
                latex_options = "hold_position")
# html output = font_size = 14 # insert in kable styling

```

### Open Access Fees

```{r oa_fees_data, echo=FALSE, warning=TRUE, eval = TRUE}

# wrangle this data so it's in long form & only includes endorsements.

OAfees_long <- df %>% 
  select (c("ParticipantNumber", 
            "OAfees_free":"OAfees_hdr",
            "FORcode_2_label")) %>%  
  select(-"OAfees_text") %>% 
  pivot_longer(c("OAfees_free":"OAfees_hdr"),
               names_to = "OAfees", 
               values_to = "OAfees_Endorsement") %>% 
  filter(OAfees_Endorsement == "1")

# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "OAfees") %>% 
    filter(NewVariable != "OAfees_text") #remove this value from metadata

d <- full_join(OAfees_long, c, by = c("OAfees" = "NewVariable")) %>% 
  rename ("OAfees_label" = "ItemText")

# getting a tibble for the counts
c_oafees <- plyr::count(d$OAfees)

# to figure out how many respondents shared concerns calculate unique number of participants
n_oafees <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(OAfees_label) %>% 
  mutate(Percentage = round (n/n_oafees*100)) %>% 
  dplyr::arrange(desc(n)) 

```

We asked all respondents, except those who said that none of their publications 
in the last 5 years were open access, how they paid for article 
processing charges that many journals charge for open access publishing. We 
provided a list of possible payment approaches and respondents were able to 
select as many concerns as they liked. A total of `r n_oafees` respondents 
answered this question. The following table presents, of those who answered this 
question, the percentage who used each of the different payment approaches.  

```{r oa_fees_bar, eval=TRUE, echo=FALSE, warning=TRUE}

# build the bar chart

# reorder the rows according to the PrePubConcern_label 
tb2 <- tb %>% 
  dplyr::mutate(OAfees_label = factor(OAfees_label, 
                levels = c("My HDR student paid the fees with their research funding", 
                           "I paid the fees with my personal money",
                            "I could not afford to pay the fees and withdrew the manuscript", 
                            "My school/faculty paid the fees",
                            "I received a fee waiver from the journal",
                            "Other method",   
                            "A non-Swinburne collaborator paid the fees",
                            "My centre/department paid the fees",
                            "I paid the fees from my own research income",
                            "My open access publications did not involve fees")))

                    
# build the bar chart
title = sprintf("How did you pay any Open Access\n publishing fees? (n = %d)", n_oafees)

p <- ggplot(tb2) + 
  aes(x = OAfees_label, y = Percentage) +
  geom_bar(stat = "identity", colour = "black", fill = "lightskyblue3") +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,70)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) # centre the title
p

```

## Additional Open Science Issues

### Most Common Open Science Practices in Their Field

```{r os_most_data, eval=TRUE, echo=FALSE}

OSmost_long <- df %>% 
  select (c("ParticipantNumber", 
            "OSmost_data":"OSmost_repo",
            "FORcode_2_label")) %>%  
  select(-"OSmost_text") %>% 
  pivot_longer(c("OSmost_data":"OSmost_repo"),
               names_to = "OSmost", 
               values_to = "OSmost_Endorsement") %>% 
  filter(OSmost_Endorsement == "1") 


# recode the data so the response options have proper labels

c <- metadata %>% 
    filter(Scale == "OSmost") %>% 
    filter(NewVariable != "OSmost_text") #remove this value from metadata

d <- full_join(OSmost_long, c, by = c("OSmost" = "NewVariable")) %>% 
  rename ("OSmost_label" = "ItemText")

# getting a tibble for the counts
c_osmost <- plyr::count(d$OSmost_label)

# to figure out how many respondents shared concerns calculate unique number of participants
n_osmost <- length(unique(d$ParticipantNumber))

# create a tibble with percentages (of respondents who answered this question) & 
# then reorder them by descending percentages
tb <- d %>% 
  dplyr::count(OSmost_label) %>% 
  mutate(Percentage = round (n/n_osmost*100)) %>% 
  dplyr::arrange(desc(n)) 
 # mutate_if(is.character, ~factor(.)) # make it a factor

```

We asked respondents which of the following open science practices (if any) were
commonly used in their field. They could tick all that applied. The graph below
represents the percentage of the `r n_osmost` respondents who selected each response.
Given that information about some of these open science practices are publicly available
and often associted with the published product (e.g., the final paper 
regularly includes links to repository storing data, materials, and/or code, as 
well as a link to the preregistration, if relevant), it is surprising that nearly
a fifth of respondents indicated that they did not know about the open science 
practices of researchers in their field. 

```{r os_most_bar, echo=FALSE, warning=TRUE, eval=TRUE}

# build the bar chart

# reorder the rows according to the _label 

tb2 <- tb %>% 
  dplyr::mutate(OSmost_label = factor(OSmost_label, 
                levels = c("None",
                           "Other",
                          "Study preregistration",
                           "Pre-publication archiving",
                           "Open materials/code",
                           "Open data",
                           "Open access archiving in a repository",
                           "Open access publishing",
                           "I don't know about the open science practices of researchers in my field")))
                
# create a character vector for the colours for each bar
cols <- c("lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "lightskyblue3", 
          "lightskyblue3", "lightskyblue3", "grey50")
                    

# build the bar chart
title = sprintf("Most common practices in\n respondent's field (n = %d)", n_osmost)

p <- ggplot(tb2) + 
  aes(x = OSmost_label, y = Percentage) +
  geom_bar(stat = "identity", colour = "black", fill = cols) +
  labs (x = element_blank(),
        y = "Percentage", 
        title = title) +
  coord_flip(ylim = c(0,70)) +
  scale_x_discrete(labels = function(x) str_wrap(x, width = 50)) + #wrap the labels
  theme_classic(base_size = 12) + 
  theme(plot.title = element_text(hjust = 0.5)) # centre the title
p

```

# The End
```{r skim df, eval=FALSE, include=FALSE}

# These are chunks from the course I took, that I'm keeping now just for reference
# As a quick first pass, we can use the 'skim()' function to get a simple overview of each variable:
#skim(df)

# Now learning about group_by which appears to be a wonderful development!

frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>% #can call "response" anything you want.
  ungroup() #get in this habit because otherwise you might retain the grouping elsewhere.


# Now playing around with it to include more summary statistics, and to print out the different summary stats in a tiblle.

frames %>%
  group_by(test_item) %>%
  summarise(
    mean_resp = mean(response),
    sd_resp = sd(response),
    count = n()
  ) %>%
  ungroup


# Now play with filter to get summary stats from just a subset of the sample (their responses to only the 'small' objects).

average_response <- frames %>%
  group_by(test_item, sample_size, n_obs, condition) %>%
  summarise(response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter(sample_size == "small") #this is not changing the average response variable because it still has everything in it.

#Now play with arrange to get summary stats from just a subset of the sample (their responses to only the 'small' objects), and arrange by condition.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition)

# Now play with select to build on filter & arrange, but to only show some of the columns.

average_response <- frames %>%
  group_by (test_item, sample_size, n_obs, condition) %>%
  summarise (response = mean(response)) %>%
  ungroup ()

average_response_small <- average_response %>%
  filter (sample_size == "small") %>%
  arrange (condition) %>%
  select (condition, test_item, response)

average_response_small

# Now use mutate to create a new variable, which takes into account how many trials they completed.

average_response_small <- average_response_small %>%
  mutate (generalisation = response/9) %>%
  select (-response) #now remove response because we don't need it any longer

average_response_small

```

```{r clean environment, echo = FALSE}
rm(a2)
rm(a3)
rm(os_exp)
rm(d2)
rm(d3)
rm(df)
rm(FOR_freq)
rm(n)
rm(nvalid_ac_level)
rm(nvalid_crisis)
rm(nvalid_disc)
rm(nvalid_os_exp)
rm(nvalid_rep_est)
```

